<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Helios C2 Demo</title>
  <style>
    :root {
      --bg: #0b1224;
      --panel: #111a30;
      --accent: #4cf0b5;
      --muted: #9ab0d6;
      --text: #e8ecf5;
      --warn: #f9c74f;
      --error: #f94144;
      --card: linear-gradient(135deg, rgba(76, 240, 181, 0.07), rgba(76, 150, 240, 0.04));
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'IBM Plex Sans', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(76, 240, 181, 0.08), transparent 35%),
                  radial-gradient(circle at 80% 10%, rgba(76, 150, 240, 0.08), transparent 30%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      position: sticky;
      top: 0;
      backdrop-filter: blur(8px);
      background: rgba(11,18,36,0.7);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      z-index: 10;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    nav a {
      color: var(--muted);
      margin-right: 16px;
      text-decoration: none;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    nav a.active, nav a:hover { color: var(--accent); }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: 12px;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 8px; letter-spacing: 0.01em; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px; }
    .kpi {
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(135deg, rgba(76, 240, 181, 0.14), rgba(76, 150, 240, 0.06));
      box-shadow: var(--shadow);
    }
    .kpi .label { color: var(--muted); font-size: 12px; letter-spacing: 0.03em; text-transform: uppercase; }
    .kpi .value { font-size: 24px; font-weight: 700; }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .card h3 { margin: 0 0 6px; }
    .muted { color: var(--muted); font-size: 14px; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 700; }
    .badge-live { background: rgba(76, 240, 181, 0.16); color: var(--accent); }
    .badge-mock { background: rgba(249, 65, 68, 0.12); color: var(--error); }
    pre {
      background: #0d152b;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius);
      padding: 12px;
      overflow: auto;
      color: var(--muted);
      white-space: pre-wrap;
      word-break: break-word;
    }
    button {
      background: linear-gradient(135deg, #4cf0b5, #4c96f0);
      color: #0a1020;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(76, 240, 181, 0.35);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 12px 34px rgba(76, 240, 181, 0.45); }
    button:active { transform: translateY(0); }
    .status-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .small { font-size: 12px; }
    .panel { margin: 24px 0; padding: 16px; border-radius: var(--radius); background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); }
    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .chip {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
    }
    .chip.active { border-color: var(--accent); color: var(--accent); box-shadow: 0 8px 20px rgba(76,240,181,0.25); }
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      color: var(--muted);
    }
    .table th, .table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align: left;
      word-break: break-word;
      white-space: normal;
    }
    .table th { color: var(--text); font-size: 12px; letter-spacing: 0.03em; text-transform: uppercase; }
    input[type="number"], input[type="text"], textarea {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 8px;
      width: 100%;
    }
    textarea { min-height: 72px; resize: vertical; }
    .list { list-style: none; padding-left: 0; margin: 0; }
    .list li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.06); color: var(--muted); white-space: normal; word-break: break-word; }
    .scroll { max-height: 260px; overflow: auto; }
    .pill-button { padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.05); color: var(--text); cursor: pointer; }
    .pill-button:hover { border-color: var(--accent); color: var(--accent); }
    a.link { color: var(--accent); text-decoration: none; }
    .hero {
      padding: 18px 16px 12px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(76, 240, 181, 0.12), rgba(76, 150, 240, 0.10));
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow);
      margin-bottom: 18px;
    }

    .info-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .info-card {
      background: rgba(13, 21, 43, 0.55);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      padding: 12px;
    }
    .info-card .title {
      font-weight: 800;
      letter-spacing: 0.02em;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text);
      margin-bottom: 6px;
    }
    .info-card .body {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    /* -------------------- Natural Language Blocks -------------------- */
    .nl {
      background: rgba(13, 21, 43, 0.55);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      padding: 12px;
      color: var(--text);
    }
    .nl .k { color: var(--muted); font-size: 12px; letter-spacing: 0.03em; text-transform: uppercase; }
    .nl .v { margin-top: 4px; color: var(--text); font-weight: 700; }
    .nl-list { margin: 8px 0 0; padding-left: 18px; color: var(--muted); }
    .nl-list li { margin: 6px 0; }
    details.nl-raw summary { cursor: pointer; color: var(--muted); }
    details.nl-raw { margin-top: 10px; }

    /* -------------------- Guided Tour -------------------- */
    .tour-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      display: none;
    }
    .tour-overlay.active { display: block; }
    .tour-card {
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: min(420px, calc(100vw - 36px));
      background: rgba(13, 21, 43, 0.92);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.55);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .tour-title { font-weight: 800; margin: 0 0 6px; }
    .tour-body { color: var(--muted); font-size: 14px; line-height: 1.4; }
    .tour-actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    .tour-actions .pill-button { flex: 1; }
    .tour-mini {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.08);
      color: var(--muted);
      font-size: 12px;
      display: flex;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
    }
    .tour-toggle {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      user-select: none;
    }
    .tour-toggle input { width: auto; }
    .tour-highlight {
      outline: 3px solid rgba(76, 240, 181, 0.9);
      outline-offset: 3px;
      border-radius: 12px;
      box-shadow: 0 0 0 8px rgba(76, 240, 181, 0.14);
      animation: tourPulse 1.3s ease-in-out infinite;
    }
    @keyframes tourPulse {
      0% { box-shadow: 0 0 0 8px rgba(76, 240, 181, 0.14); }
      50% { box-shadow: 0 0 0 14px rgba(76, 240, 181, 0.07); }
      100% { box-shadow: 0 0 0 8px rgba(76, 240, 181, 0.14); }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:10px;height:10px;border-radius:50%;background:var(--accent);"></div>
      <strong>Helios C2 Demo</strong>
      <span class="pill">In-process | Simulated infra</span>
      <button class="pill-button" id="demo-toggle" title="Toggle realistic demo data">Demo Data: On</button>
      <button class="pill-button" id="tour-start" title="Guided tour">Guided Tour</button>
    </div>
    <nav>
      <a href="#dashboard" id="nav-dashboard" class="active">Overview</a>
      <a href="#approvals" id="nav-approvals">Review</a>
      <a href="#guardrails" id="nav-guardrails">Safety</a>
      <a href="#modules" id="nav-modules">Sensors</a>
      <a href="#intel" id="nav-intel">Investigate</a>
      <a href="#infrastructure" id="nav-infrastructure">Respond</a>
      <a href="#audit" id="nav-audit">Activity</a>
      <a href="#data" id="nav-data">Live Feed</a>
    </nav>
  </header>

  <main class="container">
    <div id="dashboard" class="page">
      <div class="hero">
        <h1>Overview</h1>
        <p class="muted">A simple at-a-glance view of what the system is doing and how fast it’s running.</p>
        <span class="badge badge-live">Implemented</span>
        <div class="info-row">
          <div class="info-card">
            <div class="title">Start Here</div>
            <div class="body">Run a scenario, then come back to see new activity and recommendations update automatically.</div>
          </div>
          <div class="info-card">
            <div class="title">What You’re Seeing</div>
            <div class="body">Counts and timings from the last few runs. This page is meant to be quick and readable.</div>
          </div>
        </div>
      </div>
      <div class="kpi-row" id="dashboard-kpis"></div>
      <div class="grid">
        <div class="card" id="card-counters">
          <h3>What’s happening</h3>
          <table class="table" id="metrics-counters"></table>
        </div>
        <div class="card" id="card-timings">
          <h3>Where time is spent</h3>
          <table class="table" id="metrics-timings"></table>
        </div>
        <div class="card" id="card-metrics-explain">
          <h3>Metrics explained</h3>
          <div class="muted">Clear definitions, units, and how to interpret what you’re seeing.</div>
          <div id="metrics-explain" style="margin-top:10px;">Loading…</div>
        </div>
      </div>
      <div class="panel">
        <div class="status-row"><strong>Source</strong><span class="muted small">pipeline.export.metrics.path</span></div>
        <div class="status-row"><strong>Refresh</strong><span class="muted small">Every 5s</span></div>
        <div class="status-row"><strong>How to read</strong><span class="muted small">Counts go up as the system runs; timings are seconds (lower is faster).</span></div>
      </div>
    </div>

    <div id="approvals" class="page" style="display:none;">
      <div class="hero">
        <h1>Review & Approve</h1>
        <p class="muted">Who can approve what, and what needs a second look before action is taken.</p>
        <span class="badge badge-live">Implemented</span>
        <div class="info-row">
          <div class="info-card">
            <div class="title">What To Do</div>
            <div class="body">Use this when you want stricter review for higher-impact actions.</div>
          </div>
          <div class="info-card">
            <div class="title">Tip</div>
            <div class="body">Pair this with the Safety page to rate-limit or hold risky actions during spikes.</div>
          </div>
        </div>
      </div>
      <div id="approvals-content" class="grid"></div>
    </div>

    <div id="guardrails" class="page" style="display:none;">
      <div class="hero">
        <h1>Safety Controls</h1>
        <p class="muted">Limits and safety checks that help prevent overreaction and keep actions proportional.</p>
        <span class="badge badge-live">Implemented</span>
        <div class="info-row">
          <div class="info-card">
            <div class="title">What This Prevents</div>
            <div class="body">Too many actions too fast, repeated actions on the same asset, or bursts during noisy periods.</div>
          </div>
          <div class="info-card">
            <div class="title">How It Shows Up</div>
            <div class="body">If actions are limited, you’ll see fewer “Approved” actions and more items held for review.</div>
          </div>
        </div>
      </div>
      <div class="grid" id="guardrails-cards"></div>
    </div>

    <div id="modules" class="page" style="display:none;">
      <div class="hero">
        <h1>Sensors & Analytics</h1>
        <p class="muted">What sources are enabled and what they produce (video/audio/thermal analytics).</p>
        <span class="badge badge-live">Implemented</span>
        <div class="info-row">
          <div class="info-card">
            <div class="title">What To Do</div>
            <div class="body">Pick a sensor type to see what’s enabled and what the system will try to detect.</div>
          </div>
          <div class="info-card">
            <div class="title">Tip</div>
            <div class="body">After a run, come back here to see a quick summary of what was detected.</div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="toolbar" id="module-nav"></div>
      </div>
      <div class="grid" id="modules-config"></div>
      <div class="card" id="module-details"></div>
      <div class="panel">
        <div class="status-row"><strong>Last ingest run</strong><span class="muted small" id="modules-run-meta">Waiting for audit...</span></div>
        <div id="modules-run-stats" class="muted">No run recorded yet. Run the pipeline with media ingest enabled to see results here.</div>
        <details class="nl-raw"><summary>Raw JSON (advanced)</summary><pre id="modules-run-stats-raw">—</pre></details>
      </div>
    </div>

    <div id="intel" class="page" style="display:none;">
      <div class="hero">
        <h1>Investigations</h1>
        <p class="muted">Tools to organize observations, build a case, and review supporting artifacts.</p>
        <span class="badge badge-live">Implemented</span>
        <div class="info-row">
          <div class="info-card">
            <div class="title">Entity Profiles</div>
            <div class="body">Summaries of observed tracks over time (non-identifying). Useful for pattern-of-life style review.</div>
          </div>
          <div class="info-card">
            <div class="title">Casebook</div>
            <div class="body">Keep notes, evidence, and hypotheses in one place so you can brief others quickly.</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="toolbar" id="intel-nav"></div>
      </div>

      <div id="intel-entity" class="grid"></div>
      <div id="intel-casebook" class="grid" style="display:none;"></div>
      <div id="intel-enhance" class="grid" style="display:none;"></div>
      <div id="intel-graph" class="grid" style="display:none;"></div>
    </div>

    <div id="infrastructure" class="page" style="display:none;">
      <div class="hero">
        <h1>Response Actions</h1>
        <p class="muted">How recommended actions would be sent to downstream systems. This demo uses local files and a mock trigger.</p>
        <span class="badge badge-mock">Mock HTTP trigger</span>
      </div>
      <div class="grid">
        <div class="card">
          <h3>File Export</h3>
          <p class="muted">Writes infrastructure actions to JSONL at configured path.</p>
          <div class="status-row"><span>Status</span><span class="badge badge-live">Implemented</span></div>
          <div id="infra-file-status" class="muted">Loading...</div>
          <details class="nl-raw"><summary>Raw JSON (advanced)</summary><pre id="infra-file-status-raw">—</pre></details>
        </div>
        <div class="card">
          <h3>HTTP Forward (Mock)</h3>
          <p class="muted">Sends the last actions payload to a mock endpoint and records success/failure locally.</p>
          <div class="status-row"><span>Status</span><span class="badge badge-mock">Mocked</span></div>
          <button id="mock-send">Send Mock Payload</button>
          <div id="mock-result" class="muted">No send yet.</div>
        </div>
      </div>
    </div>

    <div id="data" class="page" style="display:none;">
      <div class="hero">
        <h1>Live Feed</h1>
        <p class="muted">The latest events, recommended actions, and a short activity stream from the most recent run.</p>
        <span class="badge badge-live">Implemented</span>
        <div class="info-row">
          <div class="info-card">
            <div class="title">What To Do</div>
            <div class="body">Check recommendations, then approve/deny the suggested course of action with a short rationale.</div>
          </div>
          <div class="info-card">
            <div class="title">What This Means</div>
            <div class="body">“Events” describe what was detected. “Actions” are suggested responses that may require review.</div>
          </div>
        </div>
      </div>
      <div class="grid">
        <div class="card">
          <h3>What was detected</h3>
          <p class="muted">Recent events and recommended actions.</p>
          <div class="status-row"><span>Events</span><span class="muted small" id="events-count">0</span></div>
          <div class="status-row"><span>Tasks</span><span class="muted small" id="tasks-count">0</span></div>
          <ul class="list scroll" id="events-preview">Waiting for data...</ul>
        </div>
        <div class="card">
          <h3>Activity stream</h3>
          <p class="muted">A short timeline of what the system just did.</p>
          <div class="status-row"><span>Status</span><span class="badge badge-live">Implemented</span></div>
          <ul class="list scroll" id="audit-preview">Waiting for data...</ul>
        </div>
        <div class="card">
          <h3>Recommendation</h3>
          <p class="muted">A short plain-language recommendation. Approve or deny with a brief reason.</p>
          <div class="status-row"><span>Status</span><span class="badge badge-live" id="action-status">—</span></div>
          <ul class="list scroll" id="action-preview">Loading...</ul>
          <div class="status-row"><span class="small">Actor</span><input type="text" id="action-actor" placeholder="approver id" />
          </div>
          <div class="status-row"><span class="small">Token</span><input type="text" id="action-token" placeholder="signing secret" /></div>
          <div class="status-row"><span class="small">Rationale</span></div>
          <textarea id="action-rationale" placeholder="why approve/deny"></textarea>
          <div style="display:flex;gap:10px;margin-top:10px;">
            <button class="pill-button" id="action-approve">Approve</button>
            <button class="pill-button" id="action-deny">Deny</button>
          </div>
        </div>
      </div>
    </div>

    <div id="audit" class="page" style="display:none;">
      <div class="hero">
        <h1>Activity Log</h1>
        <p class="muted">A detailed, append-only log of system activity for review and troubleshooting.</p>
        <span class="badge badge-live">Implemented</span>
        <div class="info-row">
          <div class="info-card">
            <div class="title">When To Use This</div>
            <div class="body">After a run, use this to understand why a recommendation was made and what checks were applied.</div>
          </div>
          <div class="info-card">
            <div class="title">Tip</div>
            <div class="body">If something looks wrong, refresh and increase the tail to see more context.</div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="toolbar">
          <span class="muted small">Tail</span>
          <input type="number" id="audit-tail" value="120" min="20" max="2000" />
          <button class="pill-button" id="audit-refresh">Refresh</button>
          <button class="pill-button" id="audit-download">Download JSON</button>
        </div>
      </div>
      <div class="grid" id="audit-summaries"></div>
      <div class="card" style="overflow:auto;">
        <table class="table" id="audit-table"></table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script>
    const navLinks = document.querySelectorAll('nav a');
    const pages = document.querySelectorAll('.page');
    navLinks.forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        const target = link.getAttribute('href');
        pages.forEach(p => p.style.display = p.id === target.substring(1) ? 'block' : 'none');
        navLinks.forEach(n => n.classList.remove('active'));
        link.classList.add('active');
          if (target === '#guardrails') {
            renderGuardrails();
          }
          if (target === '#intel') {
            initIntelUI();
            loadIntelSelected();
          }
      });
    });
    const moduleCatalog = {
      vision: { title: 'Vision', desc: 'Detections, tracks, action recognition, ALPR, optional gait embeddings.', outputs: ['Detections', 'Tracks/ReID', 'ALPR', 'Actions'] },
      audio: { title: 'Audio', desc: 'Sound event detection and quick ASR transcript.', outputs: ['Sound events', 'Transcript'] },
      thermal: { title: 'Thermal', desc: 'Thermal anomaly scan and hotspot ratios.', outputs: ['Thermal frames', 'Hotspot ratios'] },
      gait: { title: 'Gait', desc: 'Gait embeddings piggybacked on vision detections.', outputs: ['Gait embeddings'] },
      scene: { title: 'Scene Fusion', desc: 'Scene graph fused from tracks, plates, and segments.', outputs: ['Scene graph'] },
    };

    let latestAudit = [];
    let modulesCfgCache = { modules: {}, media: {}, ingest: {} };
    let moduleStatsCache = null;
    let selectedModule = 'vision';
    let guardrailCfgCache = null;

    // -------------------- Demo Mode (seeded, realistic data) --------------------
    let demoMode = (localStorage.getItem('helios_demo_mode') ?? 'true') === 'true';

    function escapeHtml(val) {
      return String(val ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function updateDemoToggle() {
      const btn = document.getElementById('demo-toggle');
      if (!btn) return;
      btn.textContent = demoMode ? 'Demo Data: On' : 'Demo Data: Off';
      btn.style.boxShadow = demoMode ? '0 10px 30px rgba(76, 240, 181, 0.35)' : 'none';
      btn.style.opacity = demoMode ? '1' : '0.85';
    }

    function setDemoMode(on) {
      demoMode = Boolean(on);
      localStorage.setItem('helios_demo_mode', demoMode ? 'true' : 'false');
      updateDemoToggle();
      // Refresh everything so the UI is consistent.
      try { loadMetrics(); } catch (_) {}
      try { loadConfig(); } catch (_) {}
      try { loadEvents(); } catch (_) {}
      try { loadAudit(); } catch (_) {}
      try { loadIntelSelected(); } catch (_) {}
    }

    document.getElementById('demo-toggle')?.addEventListener('click', () => setDemoMode(!demoMode));
    updateDemoToggle();

    function demoId(prefix) {
      return `${prefix}-${Math.random().toString(16).slice(2, 10)}`;
    }

    function buildDemoState() {
      const nowMs = Date.now();
      const mkTs = (minsAgo) => nowMs - minsAgo * 60 * 1000;

      const cfg = {
        pipeline: {
          ingest: {
            mode: 'modules_media',
            media: { stride: 8, downscale: 1.0, max_frames: 180, source: 'scenario_infra.yaml' },
            modules: {
              enable_vision: true,
              enable_audio: true,
              enable_thermal: false,
              enable_gait: true,
              enable_scene: true,
            },
          },
          guardrails: {
            rate_limits: {
              per_domain: { facility: 6, access: 8, traffic: 4 },
              per_event: 3,
              total: 14,
              per_asset_infra: 2,
              per_asset_infra_patterns: { lock: 1, dispatch_patrol: 2 },
            },
            risk_budgets: {
              demo_tenant: { max_risk: 7.5, per_action: { lock: 1.0, dispatch_patrol: 1.5, notify: 0.3 } },
            },
            health_alert_drop_ratio: 0.35,
          },
          rbac: {
            action_requirements: {
              lock: { required_roles: ['security_lead'], min_approvals: 2 },
              dispatch_patrol: { required_roles: ['security_ops'], min_approvals: 1 },
              notify: { required_roles: ['analyst'], min_approvals: 0 },
            },
          },
          infrastructure: {
            action_defaults: {
              lock: { required_roles: ['security_ops'], min_approvals: 1 },
              dispatch_patrol: { required_roles: ['security_ops'], min_approvals: 1 },
              notify: { required_roles: ['analyst'], min_approvals: 0 },
            },
          },
          export: {
            infrastructure: {
              path: 'out/infrastructure_actions.jsonl',
              rotate_max_bytes: 1048576,
              http: { enabled: false },
            },
          },
        },
      };

      const events = [
        {
          id: 'ev-0001',
          ts_ms: mkTs(6),
          category: 'perimeter_anomaly',
          domain: 'facility',
          severity: 3,
          severity_label: 'warning',
          status: 'open',
          summary: 'Unusual movement near the north fence line (after-hours)',
          entities: ['ent-01'],
          sources: ['camera:north-fence'],
        },
        {
          id: 'ev-0002',
          ts_ms: mkTs(10),
          category: 'possible_tailgating',
          domain: 'access',
          severity: 2,
          severity_label: 'notice',
          status: 'open',
          summary: 'Door access pattern suggests possible tailgating at Door A',
          entities: [],
          sources: ['badge:door-A'],
        },
        {
          id: 'ev-0003',
          ts_ms: mkTs(22),
          category: 'alpr_match',
          domain: 'traffic',
          severity: 3,
          severity_label: 'warning',
          status: 'open',
          summary: 'Plate observed at west gate; matches watchlist pattern',
          entities: ['veh-07'],
          sources: ['camera:west-gate'],
        },
        {
          id: 'ev-0004',
          ts_ms: mkTs(35),
          category: 'audio_sed',
          domain: 'facility',
          severity: 1,
          severity_label: 'info',
          status: 'closed',
          summary: 'Short impulse sound detected; no follow-on indicators',
          entities: [],
          sources: ['mic:yard-1'],
        },
        {
          id: 'ev-0005',
          ts_ms: mkTs(4),
          category: 'restricted_area_entry',
          domain: 'facility',
          severity: 4,
          severity_label: 'critical',
          status: 'open',
          summary: 'Movement detected within a restricted zone near the loading bay',
          entities: ['ent-01'],
          sources: ['camera:loading-bay'],
        },
        {
          id: 'ev-0006',
          ts_ms: mkTs(16),
          category: 'loitering',
          domain: 'facility',
          severity: 2,
          severity_label: 'notice',
          status: 'open',
          summary: 'Loitering behavior near the visitor entrance (possible recon)',
          entities: ['ent-02'],
          sources: ['camera:visitor-entrance'],
        },
        {
          id: 'ev-0007',
          ts_ms: mkTs(28),
          category: 'access_anomaly',
          domain: 'access',
          severity: 2,
          severity_label: 'notice',
          status: 'open',
          summary: 'Multiple badge retries at Door A outside normal pattern',
          entities: [],
          sources: ['badge:door-A'],
        },
      ];

      const tasks = [
        {
          id: 'task-1001',
          event_id: 'ev-0001',
          action: 'dispatch_patrol',
          asset_id: 'north_fence',
          infrastructure_type: 'patrol',
          assignee_domain: 'security',
          status: 'proposed',
          priority: 3,
          confidence: 0.76,
          rationale: 'Confirm area is clear and deter intrusion.',
        },
        {
          id: 'task-1002',
          event_id: 'ev-0003',
          action: 'notify',
          asset_id: 'west_gate',
          infrastructure_type: 'comm',
          assignee_domain: 'security',
          status: 'proposed',
          priority: 2,
          confidence: 0.64,
          rationale: 'Notify on-duty staff; verify plate via secondary camera.',
        },
        {
          id: 'task-1003',
          event_id: 'ev-0002',
          action: 'lock',
          asset_id: 'door-A',
          infrastructure_type: 'access_control',
          assignee_domain: 'security',
          status: 'pending',
          priority: 2,
          confidence: 0.58,
          rationale: 'Temporarily lock Door A pending verification (tailgating indicators).',
        },
        {
          id: 'task-1004',
          event_id: 'ev-0005',
          action: 'dispatch_patrol',
          asset_id: 'loading_bay',
          infrastructure_type: 'patrol',
          assignee_domain: 'security',
          status: 'approved',
          priority: 4,
          confidence: 0.81,
          rationale: 'Immediate on-site verification for restricted zone entry.',
        },
      ];

      const suggestion = {
        id: 'suggestion-0001',
        proposed_at: Math.floor(nowMs / 1000),
        status: 'proposed',
        plain_text: 'Dispatch a patrol to the loading bay and north fence line. Notify west gate staff to verify the plate match; hold Door A for review if tailgating persists.',
        recommended: {
          action: 'dispatch_patrol',
          asset_id: 'north_fence',
          infrastructure_type: 'patrol',
          assignee_domain: 'security',
          rationale: 'Confirm area is clear and deter intrusion.',
        },
        summary: {
          events_seen: events.length,
          tasks_approved: tasks.filter(t => t.status === 'approved').length,
          tasks_pending: tasks.filter(t => t.status !== 'approved').length,
          top_event: { id: 'ev-0005', category: 'restricted_area_entry', domain: 'facility', severity: 'critical' },
        },
      };

      const audit = [
        { seq: 1, ts_unix: Math.floor(mkTs(38) / 1000), kind: 'ingest_modules_done', actor: 'system', payload: { path: 'out/modules_media.jsonl', stride: 8, stats: { vision: 128, audio: 14, gait: 52, scene: 9 } } },
        { seq: 2, ts_unix: Math.floor(mkTs(37) / 1000), kind: 'rules_done', actor: 'system', payload: { events: 6, events_after_governance: 4, blocked: 2 } },
        { seq: 3, ts_unix: Math.floor(mkTs(36) / 1000), kind: 'guardrails', actor: 'system', payload: { kept: 2, dropped_rate_limit: 1, dropped_risk_budget: 0 } },
        { seq: 4, ts_unix: Math.floor(mkTs(6) / 1000), kind: 'action_suggestion', actor: 'system', payload: { status: 'proposed', recommended: suggestion.recommended } },
        { seq: 5, ts_unix: Math.floor(mkTs(5) / 1000), kind: 'ontology_graph_written', actor: 'system', payload: { path: 'out/graph.json', nodes: 7, edges: 4 } },
      ];

      const entityProfiles = {
        schema_version: '0.1',
        generated_at: new Date(nowMs).toISOString(),
        has_gait_tracks: true,
        summaries: [
          { entity_id: 'ent-01', track_id: 'trk-01', num_observations: 18, dominant_camera: 'north-fence', dominant_hour_of_day: 2, time_span_seconds: 240.5 },
          { entity_id: 'ent-02', track_id: 'trk-02', num_observations: 9, dominant_camera: 'visitor-entrance', dominant_hour_of_day: 1, time_span_seconds: 132.9 },
          { entity_id: 'veh-07', track_id: 'trk-veh-07', num_observations: 6, dominant_camera: 'west-gate', dominant_hour_of_day: 1, time_span_seconds: 88.2 },
        ],
        entities: [
          {
            entity_id: 'ent-01',
            track_id: 'trk-01',
            observations: Array.from({ length: 8 }).map((_, i) => ({
              ts_ms: mkTs(20 - i * 2),
              camera_id: 'north-fence',
              note: i === 0 ? 'Entered frame edge; slow pace' : 'Moving parallel to fence',
            })),
          },
          {
            entity_id: 'ent-02',
            track_id: 'trk-02',
            observations: Array.from({ length: 7 }).map((_, i) => ({
              ts_ms: mkTs(18 - i * 2),
              camera_id: 'visitor-entrance',
              note: i === 0 ? 'Paused near entrance signage' : 'Loitering near entrance',
            })),
          },
          {
            entity_id: 'veh-07',
            track_id: 'trk-veh-07',
            observations: Array.from({ length: 6 }).map((_, i) => ({
              ts_ms: mkTs(24 - i * 3),
              camera_id: 'west-gate',
              note: i === 0 ? 'Plate detected (partial)' : 'Vehicle slowing near gate',
            })),
          },
        ],
      };

      const casebook = {
        schema_version: '0.1',
        cases: [
          {
            id: 'case-001',
            title: 'Night perimeter anomaly (north fence)',
            description: 'Track repeated movement near the north fence during after-hours. Confirm whether this is benign activity or probing.',
            status: 'open',
            opened_at: Math.floor(mkTs(55) / 1000),
            domain: 'facility',
            classification: 'CUI',
          },
        ],
        evidence: [
          {
            id: 'evidence-001',
            kind: 'CCTVClip',
            description: 'Short clip from north fence camera showing movement along fence line.',
            source: 'operator',
            created_at: Math.floor(mkTs(50) / 1000),
            uri: 'out/demo_clip.mp4',
            case_ids: ['case-001'],
            tags: ['perimeter', 'after-hours'],
            classification: 'CUI',
          },
        ],
        hypotheses: [
          {
            id: 'hyp-001',
            title: 'Fence probing (low confidence)',
            description: 'Movement indicates potential probing for weak points rather than an immediate breach attempt.',
            status: 'open',
            confidence: 0.35,
            rationale: 'Repeated movement without entry attempt; timing is after-hours.',
            created_at: Math.floor(mkTs(48) / 1000),
            updated_at: Math.floor(mkTs(12) / 1000),
            case_ids: ['case-001'],
            evidence_ids: ['evidence-001'],
            classification: 'CUI',
          },
        ],
      };

      const graph = {
        schema_version: '0.1',
        generated_at: new Date(nowMs).toISOString(),
        nodes: [
          { id: 'event:ev-0001', type: 'event', label: 'Perimeter anomaly (north fence)', props: { severity: 'warning', domain: 'facility' } },
          { id: 'task:task-1001', type: 'task', label: 'dispatch_patrol', props: { status: 'proposed' } },
          { id: 'event:ev-0005', type: 'event', label: 'Restricted area entry (loading bay)', props: { severity: 'critical', domain: 'facility' } },
          { id: 'task:task-1004', type: 'task', label: 'dispatch_patrol', props: { status: 'approved' } },
          { id: 'event:ev-0002', type: 'event', label: 'Possible tailgating (Door A)', props: { severity: 'notice', domain: 'access' } },
          { id: 'task:task-1003', type: 'task', label: 'lock', props: { status: 'pending' } },
          { id: 'event:ev-0006', type: 'event', label: 'Loitering (visitor entrance)', props: { severity: 'notice', domain: 'facility' } },
          { id: 'event:ev-0003', type: 'event', label: 'Plate watchlist pattern (west gate)', props: { severity: 'warning', domain: 'traffic' } },
          { id: 'task:task-1002', type: 'task', label: 'notify', props: { status: 'proposed' } },
          { id: 'case:case-001', type: 'case', label: 'Night perimeter anomaly (north fence)', props: { status: 'open' } },
          { id: 'evidence:evidence-001', type: 'evidence', label: 'North fence clip', props: { kind: 'CCTVClip' } },
          { id: 'entity:ent-01', type: 'entity', label: 'Entity ent-01', props: { track_id: 'trk-01' } },
          { id: 'entity:ent-02', type: 'entity', label: 'Entity ent-02', props: { track_id: 'trk-02' } },
        ],
        edges: [
          { source: 'task:task-1001', type: 'RESPONDS_TO', target: 'event:ev-0001', props: {} },
          { source: 'task:task-1004', type: 'RESPONDS_TO', target: 'event:ev-0005', props: {} },
          { source: 'task:task-1003', type: 'RESPONDS_TO', target: 'event:ev-0002', props: {} },
          { source: 'task:task-1002', type: 'RESPONDS_TO', target: 'event:ev-0003', props: {} },
          { source: 'evidence:evidence-001', type: 'EVIDENCE_FOR', target: 'case:case-001', props: {} },
          { source: 'entity:ent-01', type: 'MENTIONED_IN', target: 'event:ev-0001', props: {} },
          { source: 'entity:ent-02', type: 'MENTIONED_IN', target: 'event:ev-0006', props: {} },
        ],
        stats: {
          nodes: 13,
          edges: 7,
          node_types: ['case', 'evidence', 'entity', 'event', 'task'],
          edge_types: ['EVIDENCE_FOR', 'MENTIONED_IN', 'RESPONDS_TO'],
        },
      };

      const metrics = {
        helios_ingest_count: 1,
        helios_fusion_count: 1,
        helios_rules_count: 1,
        helios_events_raw: 6,
        helios_decision_count: 2,
        helios_guardrails_count: 1,
        helios_risk_budget_count: 0,
        helios_autonomy_count: 1,
        helios_export_json_writes: 4,
        helios_ingest_seconds: 0.48,
        helios_fusion_seconds: 0.22,
        helios_rules_seconds: 0.19,
        helios_decision_seconds: 0.11,
        helios_guardrails_seconds: 0.07,
        helios_risk_budget_seconds: 0.03,
        helios_autonomy_seconds: 0.06,
      };

      return { created_at_ms: nowMs, cfg, metrics, events, tasks, suggestion, audit, entityProfiles, casebook, graph };
    }

    function getDemoState() {
      if (!window.__heliosDemoState) window.__heliosDemoState = buildDemoState();
      return window.__heliosDemoState;
    }

    // -------------------- Intel UI --------------------
    const intelTabs = {
      entity: { title: 'Entity Profiles', desc: 'Derived from modules_media outputs when available (out/entity_profiles.json).' },
      casebook: { title: 'Casebook', desc: 'Local case/evidence/hypothesis tracker (out/casebook.json).' },
      enhance: { title: 'Vision Enhancement', desc: 'Conservative deterministic enhancement + optional face redaction.' },
      graph: { title: 'Graph', desc: 'Lightweight ontology graph built from events, casebook, and entity profiles (out/graph.json).' },
    };
    let selectedIntelTab = 'entity';
    let intelInitialized = false;

    function initIntelUI() {
      if (intelInitialized) return;
      intelInitialized = true;
      const nav = document.getElementById('intel-nav');
      if (!nav) return;
      nav.innerHTML = '';
      Object.entries(intelTabs).forEach(([key, meta]) => {
        const btn = document.createElement('button');
        btn.className = `chip ${selectedIntelTab === key ? 'active' : ''}`;
        btn.dataset.tab = key;
        btn.textContent = meta.title;
        btn.addEventListener('click', () => {
          selectedIntelTab = key;
          updateIntelNavActive();
          showIntelTab(key);
          loadIntelSelected();
        });
        nav.appendChild(btn);
      });
      updateIntelNavActive();
      showIntelTab(selectedIntelTab);
      renderIntelEntitySkeleton();
      renderIntelCasebookSkeleton();
      renderIntelEnhanceSkeleton();
      renderIntelGraphSkeleton();
    }

    function updateIntelNavActive() {
      const nav = document.getElementById('intel-nav');
      if (!nav) return;
      nav.querySelectorAll('.chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.tab === selectedIntelTab);
      });
    }

    function showIntelTab(tab) {
      const entity = document.getElementById('intel-entity');
      const casebook = document.getElementById('intel-casebook');
      const enhance = document.getElementById('intel-enhance');
      const graph = document.getElementById('intel-graph');
      if (!entity || !casebook || !enhance || !graph) return;
      entity.style.display = tab === 'entity' ? 'grid' : 'none';
      casebook.style.display = tab === 'casebook' ? 'grid' : 'none';
      enhance.style.display = tab === 'enhance' ? 'grid' : 'none';
      graph.style.display = tab === 'graph' ? 'grid' : 'none';
    }

    function loadIntelSelected() {
      if (selectedIntelTab === 'entity') return loadEntityProfiles();
      if (selectedIntelTab === 'casebook') return loadCasebook();
      if (selectedIntelTab === 'enhance') return; // user-driven submit
      if (selectedIntelTab === 'graph') return loadGraph();
    }

    function renderIntelEntitySkeleton() {
      const grid = document.getElementById('intel-entity');
      if (!grid) return;
      grid.innerHTML = '';
      const info = document.createElement('div');
      info.className = 'card';
      info.innerHTML = `<h3>${intelTabs.entity.title}</h3>
        <p class="muted">${intelTabs.entity.desc}</p>
        <div class="toolbar"><button class="pill-button" id="profiles-refresh">Refresh</button></div>
        <div id="profiles-meta" class="muted">Loading...</div>
        <details class="nl-raw"><summary>Raw JSON (advanced)</summary><pre id="profiles-meta-raw">—</pre></details>`;
      const list = document.createElement('div');
      list.className = 'card';
      list.innerHTML = `<h3>Summaries</h3><table class="table" id="profiles-table"></table>`;
      const detail = document.createElement('div');
      detail.className = 'card';
      detail.innerHTML = `<h3>Entity Detail</h3>
        <div class="status-row"><span class="muted small">Entity ID</span><input id="profiles-entity-id" type="text" placeholder="ent-track or ent-uuid" /></div>
        <button class="pill-button" id="profiles-show">Show</button>
        <div id="profiles-detail" class="muted">Select an entity from the table or enter an entity id.</div>
        <details class="nl-raw"><summary>Raw JSON (advanced)</summary><pre id="profiles-detail-raw">—</pre></details>`;
      grid.appendChild(info);
      grid.appendChild(list);
      grid.appendChild(detail);

      const refresh = document.getElementById('profiles-refresh');
      if (refresh) refresh.addEventListener('click', () => loadEntityProfiles(true));
      const show = document.getElementById('profiles-show');
      if (show) show.addEventListener('click', () => {
        const id = document.getElementById('profiles-entity-id')?.value;
        if (id) renderEntityProfileDetail(window.__heliosEntityProfiles || null, id);
      });
    }

    async function loadEntityProfiles(force = false) {
      try {
        if (demoMode) {
          const demo = getDemoState();
          window.__heliosEntityProfiles = demo.entityProfiles;
          renderEntityProfiles(demo.entityProfiles);
          return;
        }
        const res = await fetch('/api/entity_profiles', { cache: force ? 'reload' : 'default' });
        if (!res.ok) throw new Error('entity profiles not found');
        const data = await res.json();
        window.__heliosEntityProfiles = data;
        renderEntityProfiles(data);
      } catch (e) {
        window.__heliosEntityProfiles = null;
        const meta = document.getElementById('profiles-meta');
        const table = document.getElementById('profiles-table');
        const detail = document.getElementById('profiles-detail');
        if (meta) meta.textContent = 'entity_profiles.json not found yet. Run ingest.mode: modules_media to generate.';
        if (table) table.innerHTML = '<tr><td class="muted" colspan="6">No entity profiles available.</td></tr>';
        if (detail) detail.textContent = 'No entity profile loaded.';
      }
    }

    function renderEntityProfiles(data) {
      const meta = document.getElementById('profiles-meta');
      const table = document.getElementById('profiles-table');
      const raw = document.getElementById('profiles-meta-raw');
      if (!meta || !table) return;
      const summaries = data?.summaries || [];
      const entitiesCount = (data?.entities || []).length;
      const generatedAt = data?.generated_at ? new Date(data.generated_at).toLocaleString() : '—';
      const sourceLabel = demoMode ? 'Demo Data (seeded)' : 'Live API (/api/entity_profiles)';
      meta.innerHTML = `<div class="nl">
        <div class="k">What this is</div>
        <div class="v">Non-identifying summaries of tracked entities</div>
        <ul class="nl-list">
          <li>${entitiesCount} entity record(s), ${summaries.length} summary row(s)</li>
          <li>Gait tracks present: ${data?.has_gait_tracks ? 'yes' : 'no/unknown'}</li>
          <li>Generated: ${generatedAt}</li>
          <li>Source: ${escapeHtml(sourceLabel)}</li>
        </ul>
      </div>`;
      if (raw) raw.textContent = JSON.stringify(data, null, 2);

      if (!summaries.length) {
        table.innerHTML = '<tr><td class="muted" colspan="6">No summaries.</td></tr>';
        return;
      }
      table.innerHTML = '<tr><th>Entity</th><th>Track</th><th>Obs</th><th>Dominant Camera</th><th>Dominant Hour</th><th>Span (s)</th></tr>';
      summaries.slice(0, 50).forEach(s => {
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.innerHTML = `<td>${escapeHtml(s.entity_id || '—')}</td><td>${escapeHtml(s.track_id || '—')}</td><td>${escapeHtml(s.num_observations ?? 0)}</td><td>${escapeHtml(s.dominant_camera ?? '—')}</td><td>${escapeHtml(s.dominant_hour_of_day ?? '—')}</td><td>${escapeHtml((s.time_span_seconds ?? 0).toFixed ? (s.time_span_seconds ?? 0).toFixed(1) : (s.time_span_seconds ?? 0))}</td>`;
        row.addEventListener('click', () => {
          const input = document.getElementById('profiles-entity-id');
          if (input) input.value = s.entity_id;
          renderEntityProfileDetail(data, s.entity_id);
        });
        table.appendChild(row);
      });
    }

    function renderEntityProfileDetail(data, entityId) {
      const pre = document.getElementById('profiles-detail');
      const raw = document.getElementById('profiles-detail-raw');
      if (!pre) return;
      const entities = data?.entities || [];
      const found = entities.find(e => e.entity_id === entityId);
      if (!found) {
        pre.textContent = `Entity not found: ${entityId}`;
        if (raw) raw.textContent = '—';
        return;
      }
      // Keep detail concise.
      const obs = (found.observations || []).slice(0, 20);
      const total = (found.observations || []).length;
      const cameras = [...new Set((found.observations || []).map(o => o.camera_id).filter(Boolean))].slice(0, 6);
      pre.innerHTML = `<div class="nl">
        <div class="k">Entity</div>
        <div class="v">${escapeHtml(found.entity_id || '—')}</div>
        <ul class="nl-list">
          <li>Track: ${escapeHtml(found.track_id || '—')}</li>
          <li>Observations: ${total} (showing ${obs.length})</li>
          <li>Cameras: ${escapeHtml(cameras.length ? cameras.join(', ') : '—')}</li>
        </ul>
        <div class="k" style="margin-top:10px;">Recent observations</div>
        <table class="table" style="margin-top:6px;">
          <tr><th>Time</th><th>Camera</th><th>Note</th></tr>
          ${obs.map(o => {
            const t = o.ts_ms ? new Date(o.ts_ms).toLocaleString() : '—';
            return `<tr><td>${escapeHtml(t)}</td><td>${escapeHtml(o.camera_id || '—')}</td><td>${escapeHtml(o.note || '—')}</td></tr>`;
          }).join('')}
        </table>
      </div>`;
      if (raw) raw.textContent = JSON.stringify(found, null, 2);
    }

    function renderIntelCasebookSkeleton() {
      const grid = document.getElementById('intel-casebook');
      if (!grid) return;
      grid.innerHTML = '';
      const actions = document.createElement('div');
      actions.className = 'card';
      actions.innerHTML = `<h3>${intelTabs.casebook.title}</h3>
        <p class="muted">${intelTabs.casebook.desc}</p>
        <div class="toolbar"><button class="pill-button" id="casebook-refresh">Refresh</button></div>
        <div id="casebook-meta" class="muted">Loading...</div>`;

      const createCase = document.createElement('div');
      createCase.className = 'card';
      createCase.innerHTML = `<h3>Create Case</h3>
        <div class="status-row"><span class="muted small">Title</span><input type="text" id="case-title" placeholder="e.g., Night perimeter anomaly" /></div>
        <div class="status-row"><span class="muted small">Domain</span><input type="text" id="case-domain" value="facility" /></div>
        <div class="status-row"><span class="muted small">Description</span></div>
        <textarea id="case-desc" placeholder="short description"></textarea>
        <button class="pill-button" id="case-create">Create</button>
        <pre id="case-create-result">—</pre>`;

      const addEvidence = document.createElement('div');
      addEvidence.className = 'card';
      addEvidence.innerHTML = `<h3>Add Evidence</h3>
        <div class="status-row"><span class="muted small">Kind</span><input type="text" id="ev-kind" value="CCTVClip" /></div>
        <div class="status-row"><span class="muted small">Source</span><input type="text" id="ev-source" value="operator" /></div>
        <div class="status-row"><span class="muted small">URI (optional)</span><input type="text" id="ev-uri" placeholder="file:// or http://" /></div>
        <div class="status-row"><span class="muted small">Case IDs (comma)</span><input type="text" id="ev-case-ids" placeholder="case-..." /></div>
        <div class="status-row"><span class="muted small">Tags (comma)</span><input type="text" id="ev-tags" placeholder="alpr, person" /></div>
        <div class="status-row"><span class="muted small">Description</span></div>
        <textarea id="ev-desc" placeholder="what this evidence is"></textarea>
        <button class="pill-button" id="ev-add">Add</button>
        <pre id="ev-add-result">—</pre>`;

      const createHyp = document.createElement('div');
      createHyp.className = 'card';
      createHyp.innerHTML = `<h3>Create Hypothesis</h3>
        <div class="status-row"><span class="muted small">Title</span><input type="text" id="hyp-title" placeholder="e.g., Tailgating attempt" /></div>
        <div class="status-row"><span class="muted small">Confidence</span><input type="number" id="hyp-conf" min="0" max="1" step="0.05" value="0.3" /></div>
        <div class="status-row"><span class="muted small">Case IDs (comma)</span><input type="text" id="hyp-case-ids" placeholder="case-..." /></div>
        <div class="status-row"><span class="muted small">Evidence IDs (comma)</span><input type="text" id="hyp-ev-ids" placeholder="ev-..." /></div>
        <div class="status-row"><span class="muted small">Description</span></div>
        <textarea id="hyp-desc" placeholder="hypothesis statement"></textarea>
        <div class="status-row"><span class="muted small">Rationale</span></div>
        <textarea id="hyp-rationale" placeholder="why you believe this"></textarea>
        <button class="pill-button" id="hyp-create">Create</button>
        <pre id="hyp-create-result">—</pre>`;

      const view = document.createElement('div');
      view.className = 'card';
      view.innerHTML = `<h3>Casebook (readable)</h3>
        <div class="muted">A human-friendly view of cases, evidence, and hypotheses.</div>
        <div id="casebook-readable" style="margin-top:10px;">
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
            <div class="card" style="box-shadow:none;border:1px solid rgba(255,255,255,0.06);">
              <strong>Cases</strong>
              <div class="muted small">Select one to see details.</div>
              <div id="casebook-cases" style="margin-top:8px;"></div>
            </div>
            <div class="card" style="box-shadow:none;border:1px solid rgba(255,255,255,0.06);">
              <strong>Selected case</strong>
              <div id="casebook-selected" class="muted" style="margin-top:8px;">—</div>
            </div>
            <div class="card" style="box-shadow:none;border:1px solid rgba(255,255,255,0.06);">
              <strong>Evidence</strong>
              <div id="casebook-evidence" class="muted" style="margin-top:8px;">—</div>
            </div>
            <div class="card" style="box-shadow:none;border:1px solid rgba(255,255,255,0.06);">
              <strong>Hypotheses</strong>
              <div id="casebook-hypotheses" class="muted" style="margin-top:8px;">—</div>
            </div>
          </div>
        </div>
        <details style="margin-top:10px;">
          <summary class="muted" style="cursor:pointer;">Raw JSON (advanced)</summary>
          <pre id="casebook-json">Waiting...</pre>
        </details>`;

      grid.appendChild(actions);
      grid.appendChild(createCase);
      grid.appendChild(addEvidence);
      grid.appendChild(createHyp);
      grid.appendChild(view);

      document.getElementById('casebook-refresh')?.addEventListener('click', () => loadCasebook(true));
      document.getElementById('case-create')?.addEventListener('click', async () => {
        const title = document.getElementById('case-title')?.value || 'Untitled';
        const domain = document.getElementById('case-domain')?.value || 'facility';
        const description = document.getElementById('case-desc')?.value || '';
        await casebookPost({ op: 'create_case', title, domain, description }, 'case-create-result');
        loadCasebook(true);
      });
      document.getElementById('ev-add')?.addEventListener('click', async () => {
        const kind = document.getElementById('ev-kind')?.value || 'Evidence';
        const source = document.getElementById('ev-source')?.value || 'operator';
        const uri = document.getElementById('ev-uri')?.value || null;
        const description = document.getElementById('ev-desc')?.value || '';
        const caseIds = (document.getElementById('ev-case-ids')?.value || '').split(',').map(s => s.trim()).filter(Boolean);
        const tags = (document.getElementById('ev-tags')?.value || '').split(',').map(s => s.trim()).filter(Boolean);
        await casebookPost({ op: 'add_evidence', kind, source, uri, description, case_ids: caseIds, tags }, 'ev-add-result');
        loadCasebook(true);
      });
      document.getElementById('hyp-create')?.addEventListener('click', async () => {
        const title = document.getElementById('hyp-title')?.value || 'Hypothesis';
        const confidence = Number(document.getElementById('hyp-conf')?.value || 0.0);
        const description = document.getElementById('hyp-desc')?.value || '';
        const rationale = document.getElementById('hyp-rationale')?.value || '';
        const caseIds = (document.getElementById('hyp-case-ids')?.value || '').split(',').map(s => s.trim()).filter(Boolean);
        const evidenceIds = (document.getElementById('hyp-ev-ids')?.value || '').split(',').map(s => s.trim()).filter(Boolean);
        await casebookPost({ op: 'create_hypothesis', title, description, rationale, confidence, case_ids: caseIds, evidence_ids: evidenceIds }, 'hyp-create-result');
        loadCasebook(true);
      });
    }

    async function casebookPost(payload, resultElId) {
      const out = document.getElementById(resultElId);
      if (out) out.textContent = 'Sending...';
      try {
        if (demoMode) {
          const demo = getDemoState();
          const op = String(payload?.op || '').trim();
          if (!demo.casebook) demo.casebook = { schema_version: '0.1', cases: [], evidence: [], hypotheses: [] };

          if (op === 'create_case') {
            const created = {
              id: demoId('case'),
              title: String(payload.title || 'Untitled'),
              description: String(payload.description || ''),
              status: 'open',
              opened_at: Math.floor(Date.now() / 1000),
              domain: String(payload.domain || 'facility'),
              classification: 'CUI',
            };
            demo.casebook.cases.unshift(created);
            if (out) out.textContent = JSON.stringify({ ok: true, case: created, demo: true }, null, 2);
            renderCasebookReadable(demo.casebook);
            const pre = document.getElementById('casebook-json');
            if (pre) pre.textContent = JSON.stringify(demo.casebook, null, 2);
            return;
          }
          if (op === 'add_evidence') {
            const created = {
              id: demoId('evidence'),
              kind: String(payload.kind || 'Evidence'),
              description: String(payload.description || ''),
              source: String(payload.source || 'operator'),
              created_at: Math.floor(Date.now() / 1000),
              uri: payload.uri || null,
              case_ids: Array.isArray(payload.case_ids) ? payload.case_ids : [],
              tags: Array.isArray(payload.tags) ? payload.tags : [],
              classification: 'CUI',
            };
            demo.casebook.evidence.unshift(created);
            if (out) out.textContent = JSON.stringify({ ok: true, evidence: created, demo: true }, null, 2);
            renderCasebookReadable(demo.casebook);
            const pre = document.getElementById('casebook-json');
            if (pre) pre.textContent = JSON.stringify(demo.casebook, null, 2);
            return;
          }
          if (op === 'create_hypothesis') {
            const created = {
              id: demoId('hyp'),
              title: String(payload.title || 'Hypothesis'),
              description: String(payload.description || ''),
              status: 'open',
              confidence: Number(payload.confidence || 0.0),
              rationale: String(payload.rationale || ''),
              created_at: Math.floor(Date.now() / 1000),
              updated_at: Math.floor(Date.now() / 1000),
              case_ids: Array.isArray(payload.case_ids) ? payload.case_ids : [],
              evidence_ids: Array.isArray(payload.evidence_ids) ? payload.evidence_ids : [],
              classification: 'CUI',
            };
            demo.casebook.hypotheses.unshift(created);
            if (out) out.textContent = JSON.stringify({ ok: true, hypothesis: created, demo: true }, null, 2);
            renderCasebookReadable(demo.casebook);
            const pre = document.getElementById('casebook-json');
            if (pre) pre.textContent = JSON.stringify(demo.casebook, null, 2);
            return;
          }

          if (out) out.textContent = JSON.stringify({ ok: false, error: `unknown op: ${op}`, demo: true }, null, 2);
          return;
        }

        const res = await fetch('/api/casebook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'request failed');
        if (out) out.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        if (out) out.textContent = `Failed: ${e.message || e}`;
      }
    }

    async function loadCasebook(force = false) {
      try {
        if (demoMode) {
          const demo = getDemoState();
          const meta = document.getElementById('casebook-meta');
          const pre = document.getElementById('casebook-json');
          if (meta) meta.textContent = `Demo casebook: ${demo.casebook.cases.length} case(s) · ${demo.casebook.evidence.length} evidence item(s) · ${demo.casebook.hypotheses.length} hypothesis/hypotheses.`;
          if (pre) pre.textContent = JSON.stringify(demo.casebook, null, 2);
          renderCasebookReadable(demo.casebook);
          return;
        }

        const res = await fetch('/api/casebook', { cache: force ? 'reload' : 'default' });
        if (!res.ok) throw new Error('casebook unavailable');
        const data = await res.json();
        const meta = document.getElementById('casebook-meta');
        const pre = document.getElementById('casebook-json');
        if (meta) meta.textContent = `${(data?.cases || []).length} case(s) · ${(data?.evidence || []).length} evidence item(s) · ${(data?.hypotheses || []).length} hypothesis/hypotheses.`;
        if (pre) pre.textContent = JSON.stringify(data, null, 2);
        renderCasebookReadable(data);
      } catch (e) {
        const meta = document.getElementById('casebook-meta');
        const pre = document.getElementById('casebook-json');
        if (meta) meta.textContent = demoMode ? 'Demo casebook unavailable.' : 'Casebook not found yet. It will be created automatically after your first create/add action.';
        if (pre) pre.textContent = '—';
        renderCasebookReadable(null);
      }
    }

    function renderCasebookReadable(data) {
      const casesEl = document.getElementById('casebook-cases');
      const selectedEl = document.getElementById('casebook-selected');
      const evidenceEl = document.getElementById('casebook-evidence');
      const hypsEl = document.getElementById('casebook-hypotheses');
      if (!casesEl || !selectedEl || !evidenceEl || !hypsEl) return;

      if (!data) {
        casesEl.innerHTML = '<div class="muted">No casebook loaded yet.</div>';
        selectedEl.textContent = '—';
        evidenceEl.textContent = '—';
        hypsEl.textContent = '—';
        return;
      }

      const cases = Array.isArray(data.cases) ? data.cases : [];
      const evidence = Array.isArray(data.evidence) ? data.evidence : [];
      const hypotheses = Array.isArray(data.hypotheses) ? data.hypotheses : [];

      if (!window.__casebookSelectedId && cases.length) window.__casebookSelectedId = cases[0].id;
      if (cases.length && !cases.find(c => c.id === window.__casebookSelectedId)) window.__casebookSelectedId = cases[0].id;

      casesEl.innerHTML = '';
      if (!cases.length) {
        casesEl.innerHTML = '<div class="muted">No cases yet. Create one on the left.</div>';
      } else {
        cases.slice(0, 10).forEach(c => {
          const btn = document.createElement('button');
          btn.className = 'pill-button';
          btn.style.width = '100%';
          btn.style.marginBottom = '8px';
          btn.style.border = '1px solid rgba(255,255,255,0.12)';
          btn.style.background = window.__casebookSelectedId === c.id ? 'rgba(76,240,181,0.16)' : 'rgba(255,255,255,0.05)';
          btn.style.color = 'var(--text)';
          btn.textContent = `${c.title || c.id} (${c.status || 'open'})`;
          btn.addEventListener('click', () => {
            window.__casebookSelectedId = c.id;
            renderCasebookReadable(data);
          });
          casesEl.appendChild(btn);
        });
      }

      const selected = cases.find(c => c.id === window.__casebookSelectedId) || cases[0] || null;
      if (!selected) {
        selectedEl.textContent = 'No case selected.';
        evidenceEl.textContent = '—';
        hypsEl.textContent = '—';
        return;
      }

      const opened = selected.opened_at ? new Date(selected.opened_at * 1000).toLocaleString() : '—';
      selectedEl.innerHTML = `
        <div><strong>${selected.title || selected.id}</strong></div>
        <div class="muted small">Domain: ${selected.domain || '—'} · Classification: ${selected.classification || '—'} · Opened: ${opened}</div>
        <div style="margin-top:8px;">${(selected.description || '').trim() || '<span class="muted">No description.</span>'}</div>
      `;

      const evForCase = evidence.filter(ev => (ev.case_ids || []).includes(selected.id));
      const hypForCase = hypotheses.filter(h => (h.case_ids || []).includes(selected.id));

      if (!evForCase.length) {
        evidenceEl.innerHTML = '<div class="muted">No evidence linked to this case yet.</div>';
      } else {
        evidenceEl.innerHTML = evForCase.slice(0, 10).map(ev => {
          const when = ev.created_at ? new Date(ev.created_at * 1000).toLocaleString() : '—';
          const tags = (ev.tags || []).length ? ` · Tags: ${(ev.tags || []).join(', ')}` : '';
          const uri = ev.uri ? ` · URI: ${ev.uri}` : '';
          return `<div style="margin-bottom:10px;">
            <div><strong>${ev.kind || 'Evidence'}</strong> — ${(ev.description || '').trim() || '—'}</div>
            <div class="muted small">${when} · Source: ${ev.source || '—'}${tags}${uri}</div>
          </div>`;
        }).join('');
      }

      if (!hypForCase.length) {
        hypsEl.innerHTML = '<div class="muted">No hypotheses for this case yet.</div>';
      } else {
        hypsEl.innerHTML = hypForCase.slice(0, 10).map(h => {
          const conf = (h.confidence ?? 0);
          const pct = (typeof conf === 'number' && isFinite(conf)) ? Math.round(conf * 100) : '—';
          const updated = h.updated_at ? new Date(h.updated_at * 1000).toLocaleString() : '—';
          const status = h.status || 'open';
          return `<div style="margin-bottom:10px;">
            <div><strong>${h.title || h.id}</strong> (${status}, ${pct}% confidence)</div>
            <div style="margin-top:6px;">${(h.description || '').trim() || '<span class="muted">No description.</span>'}</div>
            <div class="muted small" style="margin-top:6px;">Updated: ${updated}</div>
            ${h.rationale ? `<div class="muted small" style="margin-top:6px;">Rationale: ${h.rationale}</div>` : ''}
          </div>`;
        }).join('');
      }
    }

    function renderIntelEnhanceSkeleton() {
      const grid = document.getElementById('intel-enhance');
      if (!grid) return;
      grid.innerHTML = '';
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h3>${intelTabs.enhance.title}</h3>
        <p class="muted">${intelTabs.enhance.desc} Provide a server-local path to a video file (e.g., under the workspace).</p>
        <div class="status-row"><span class="muted small">Video path</span><input id="enh-video" type="text" placeholder="/workspaces/.../some.mp4" /></div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
          <div class="card" style="box-shadow:none;border:1px solid rgba(255,255,255,0.06);">
            <div class="status-row"><span class="muted small">Deinterlace</span><input id="enh-deint" type="text" value="false" /></div>
            <div class="status-row"><span class="muted small">Stabilize</span><input id="enh-stab" type="text" value="true" /></div>
            <div class="status-row"><span class="muted small">Redact faces</span><input id="enh-redact" type="text" value="false" /></div>
          </div>
          <div class="card" style="box-shadow:none;border:1px solid rgba(255,255,255,0.06);">
            <div class="status-row"><span class="muted small">Denoise window</span><input id="enh-denoise" type="number" value="2" min="0" max="8" /></div>
            <div class="status-row"><span class="muted small">Sharpen amount</span><input id="enh-sharp" type="number" value="0.8" step="0.1" min="0" max="2" /></div>
            <div class="status-row"><span class="muted small">SR scale</span><input id="enh-scale" type="number" value="2" min="1" max="4" /></div>
          </div>
          <div class="card" style="box-shadow:none;border:1px solid rgba(255,255,255,0.06);">
            <div class="status-row"><span class="muted small">Max frames</span><input id="enh-max" type="number" value="120" min="1" max="5000" /></div>
            <div class="muted small">Tip: keep max frames small for quick runs.</div>
          </div>
        </div>
        <button class="pill-button" id="enh-run">Run Enhancement</button>
        <pre id="enh-result">—</pre>
        <div id="enh-artifacts"></div>`;
      grid.appendChild(card);

      document.getElementById('enh-run')?.addEventListener('click', async () => {
        const video_path = document.getElementById('enh-video')?.value?.trim();
        if (!video_path) return alert('Provide a server-local video path.');
        const cfg = {
          deinterlace: (document.getElementById('enh-deint')?.value || 'false') === 'true',
          stabilize: (document.getElementById('enh-stab')?.value || 'true') === 'true',
          redact_faces: (document.getElementById('enh-redact')?.value || 'false') === 'true',
          denoise_window: Number(document.getElementById('enh-denoise')?.value || 2),
          sharpen_amount: Number(document.getElementById('enh-sharp')?.value || 0.8),
          sr_scale: Number(document.getElementById('enh-scale')?.value || 2),
          max_frames: Number(document.getElementById('enh-max')?.value || 120),
        };
        await runEnhancement(video_path, cfg);
      });
    }

    async function runEnhancement(video_path, config) {
      const pre = document.getElementById('enh-result');
      const artifacts = document.getElementById('enh-artifacts');
      if (pre) pre.textContent = 'Running...';
      if (artifacts) artifacts.innerHTML = '';
      try {
        const res = await fetch('/api/enhance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ video_path, config }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.detail || data?.error || 'enhancement failed');
        if (pre) pre.textContent = JSON.stringify(data.result, null, 2);

        const urls = data?.result?.artifact_urls || {};
        const paths = data?.result?.artifact_paths || {};
        if (artifacts) {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `<h3>Artifacts</h3>
            <div class="status-row"><span>Video</span><span class="muted small">${paths.video || '—'}</span></div>
            <div class="status-row"><span>Montage</span><span class="muted small">${paths.montage || '—'}</span></div>
            <div class="status-row"><span>Metadata</span><span class="muted small">${paths.metadata || '—'}</span></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              ${urls.video ? `<a class="link" href="${urls.video}" target="_blank">Open video</a>` : ''}
              ${urls.montage ? `<a class="link" href="${urls.montage}" target="_blank">Open montage</a>` : ''}
              ${urls.metadata ? `<a class="link" href="${urls.metadata}" target="_blank">Open metadata</a>` : ''}
            </div>
            ${urls.montage ? `<div style="margin-top:10px;"><img src="${urls.montage}" style="max-width:100%;border-radius:12px;border:1px solid rgba(255,255,255,0.08);" /></div>` : ''}
            ${urls.video ? `<div style="margin-top:10px;"><video controls style="width:100%;border-radius:12px;border:1px solid rgba(255,255,255,0.08);" src="${urls.video}"></video></div>` : ''}`;
          artifacts.appendChild(card);
        }
      } catch (e) {
        if (pre) pre.textContent = `Failed: ${e.message || e}`;
      }
    }

    function renderIntelGraphSkeleton() {
      const grid = document.getElementById('intel-graph');
      if (!grid) return;
      grid.innerHTML = '';

      const info = document.createElement('div');
      info.className = 'card';
      info.innerHTML = `<h3>${intelTabs.graph.title}</h3>
        <p class="muted">${intelTabs.graph.desc}</p>
        <div class="toolbar">
          <button class="pill-button" id="graph-refresh">Refresh</button>
        </div>
        <div id="graph-meta" class="muted">Loading...</div>
        <details class="nl-raw"><summary>Raw JSON (advanced)</summary><pre id="graph-raw">—</pre></details>`;

      const browse = document.createElement('div');
      browse.className = 'card';
      browse.innerHTML = `<h3>Browse</h3>
        <div class="status-row"><span class="muted small">Search</span><input id="graph-search" type="text" placeholder="node id / label / type" /></div>
        <div class="toolbar">
          <button class="pill-button" id="graph-clear">Clear</button>
        </div>
        <div class="muted small">Shows first 50 matching nodes and edges.</div>`;

      const nodesCard = document.createElement('div');
      nodesCard.className = 'card';
      nodesCard.innerHTML = `<h3>Nodes</h3><table class="table" id="graph-nodes"></table>`;

      const edgesCard = document.createElement('div');
      edgesCard.className = 'card';
      edgesCard.innerHTML = `<h3>Edges</h3><table class="table" id="graph-edges"></table>`;

      grid.appendChild(info);
      grid.appendChild(browse);
      grid.appendChild(nodesCard);
      grid.appendChild(edgesCard);

      document.getElementById('graph-refresh')?.addEventListener('click', () => loadGraph(true));
      document.getElementById('graph-clear')?.addEventListener('click', () => {
        const input = document.getElementById('graph-search');
        if (input) input.value = '';
        renderGraph(window.__heliosGraph || null);
      });
      document.getElementById('graph-search')?.addEventListener('input', () => {
        renderGraph(window.__heliosGraph || null);
      });
    }

    async function loadGraph(force = false) {
      try {
        if (demoMode) {
          const demo = getDemoState();
          window.__heliosGraph = demo.graph;
          renderGraph(demo.graph);
          return;
        }
        const res = await fetch('/api/graph', { cache: force ? 'reload' : 'default' });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.detail || data?.error || 'graph unavailable');
        window.__heliosGraph = data;
        renderGraph(data);
      } catch (e) {
        window.__heliosGraph = null;
        const meta = document.getElementById('graph-meta');
        const nodes = document.getElementById('graph-nodes');
        const edges = document.getElementById('graph-edges');
        if (meta) meta.textContent = `Graph not available yet. Run the pipeline or create casebook items to generate out/graph.json. (${e.message || e})`;
        if (nodes) nodes.innerHTML = '<tr><td class="muted">No nodes.</td></tr>';
        if (edges) edges.innerHTML = '<tr><td class="muted">No edges.</td></tr>';
      }
    }

    function renderGraph(graph) {
      const meta = document.getElementById('graph-meta');
      const nodesTable = document.getElementById('graph-nodes');
      const edgesTable = document.getElementById('graph-edges');
      const raw = document.getElementById('graph-raw');
      if (!meta || !nodesTable || !edgesTable) return;

      if (!graph) {
        meta.textContent = 'No graph loaded.';
        nodesTable.innerHTML = '<tr><td class="muted">No nodes.</td></tr>';
        edgesTable.innerHTML = '<tr><td class="muted">No edges.</td></tr>';
        return;
      }

      const q = (document.getElementById('graph-search')?.value || '').trim().toLowerCase();
      const nodes = Array.isArray(graph.nodes) ? graph.nodes : [];
      const edges = Array.isArray(graph.edges) ? graph.edges : [];

      const generatedAt = graph.generated_at ? new Date(graph.generated_at).toLocaleString() : '—';
      const nodeTypes = graph?.stats?.node_types || [];
      const edgeTypes = graph?.stats?.edge_types || [];
      const sourceLabel = demoMode ? 'Demo Data (seeded)' : 'Live API (/api/graph)';
      meta.innerHTML = `<div class="nl">
        <div class="k">What this is</div>
        <div class="v">A relationship map between events, actions, cases, evidence, and entities</div>
        <ul class="nl-list">
          <li>Generated: ${escapeHtml(generatedAt)}</li>
          <li>${nodes.length} nodes (${escapeHtml(nodeTypes.length ? nodeTypes.join(', ') : 'types unknown')})</li>
          <li>${edges.length} edges (${escapeHtml(edgeTypes.length ? edgeTypes.join(', ') : 'types unknown')})</li>
          <li>Source: ${escapeHtml(sourceLabel)}</li>
        </ul>
      </div>`;
      if (raw) raw.textContent = JSON.stringify(graph, null, 2);

      const nodeMatches = (n) => {
        if (!q) return true;
        const hay = `${n.id || ''} ${n.type || ''} ${n.label || ''}`.toLowerCase();
        return hay.includes(q);
      };
      const edgeMatches = (e) => {
        if (!q) return true;
        const hay = `${e.source || ''} ${e.type || ''} ${e.target || ''}`.toLowerCase();
        return hay.includes(q);
      };

      const viewNodes = nodes.filter(nodeMatches).slice(0, 50);
      const viewEdges = edges.filter(edgeMatches).slice(0, 50);

      if (!viewNodes.length) {
        nodesTable.innerHTML = '<tr><td class="muted">No matching nodes.</td></tr>';
      } else {
        nodesTable.innerHTML = '<tr><th>ID</th><th>Type</th><th>Label</th></tr>';
        viewNodes.forEach(n => {
          const row = document.createElement('tr');
          row.style.cursor = 'pointer';
          row.innerHTML = `<td>${escapeHtml(n.id || '—')}</td><td>${escapeHtml(n.type || '—')}</td><td>${escapeHtml(n.label || '—')}</td>`;
          row.addEventListener('click', () => {
            const input = document.getElementById('graph-search');
            if (input) input.value = (n.id || '').toString();
            renderGraph(graph);
          });
          nodesTable.appendChild(row);
        });
      }

      if (!viewEdges.length) {
        edgesTable.innerHTML = '<tr><td class="muted">No matching edges.</td></tr>';
      } else {
        edgesTable.innerHTML = '<tr><th>Source</th><th>Type</th><th>Target</th></tr>';
        viewEdges.forEach(e => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${escapeHtml(e.source || '—')}</td><td>${escapeHtml(e.type || '—')}</td><td>${escapeHtml(e.target || '—')}</td>`;
          edgesTable.appendChild(row);
        });
      }
    }

    async function loadMetrics() {
      const kpi = document.getElementById('dashboard-kpis');
      const countersTable = document.getElementById('metrics-counters');
      const timingsTable = document.getElementById('metrics-timings');
      const explain = document.getElementById('metrics-explain');
      try {
        const METRIC_CATALOG = {
          // Timed pipeline stages (timer() produces *_seconds + *_count)
          helios_ingest_seconds: {
            meaning: 'Total time spent ingesting inputs (read/collect sensor data).',
            units: 'seconds (cumulative)',
            interpret: 'Compare against ingest_count to get average per run. Spikes often mean slower I/O or heavier media input.',
          },
          helios_ingest_count: {
            meaning: 'How many times ingest completed (i.e., pipeline runs that reached ingest).',
            units: 'runs',
            interpret: 'Use with ingest_seconds to estimate average ingest time.',
          },
          helios_fusion_seconds: {
            meaning: 'Total time spent fusing readings into higher-level objects (tracks/scene).',
            units: 'seconds (cumulative)',
            interpret: 'If fusion_seconds grows quickly per run, fusion work is heavier (more detections/tracks) or compute is constrained.',
          },
          helios_fusion_count: {
            meaning: 'How many times fusion completed.',
            units: 'runs',
            interpret: 'Use with fusion_seconds to estimate average fusion time.',
          },
          helios_rules_seconds: {
            meaning: 'Total time spent evaluating rules to produce events/tasks.',
            units: 'seconds (cumulative)',
            interpret: 'Higher per run usually means more readings/events or more rules firing.',
          },
          helios_rules_count: {
            meaning: 'How many times rules evaluation completed.',
            units: 'runs',
            interpret: 'Use with rules_seconds to estimate average rules time.',
          },
          helios_decision_seconds: {
            meaning: 'Total time spent producing recommended actions from tasks.',
            units: 'seconds (cumulative)',
            interpret: 'Usually small; if it grows, decision logic or suggestion formatting is heavier.',
          },
          helios_decision_count: {
            meaning: 'How many times action decision logic completed.',
            units: 'runs',
            interpret: 'Use with decision_seconds to estimate average decision time.',
          },
          helios_guardrails_seconds: {
            meaning: 'Total time spent applying safety guardrails (rate limits, per-asset limits).',
            units: 'seconds (cumulative)',
            interpret: 'Spikes can indicate many candidate actions being checked.',
          },
          helios_guardrails_count: {
            meaning: 'How many times guardrails evaluation completed.',
            units: 'runs',
            interpret: 'Use with guardrails_seconds to estimate average guardrails time.',
          },
          helios_risk_budget_seconds: {
            meaning: 'Total time spent evaluating risk budgets (holding or releasing risky actions).',
            units: 'seconds (cumulative)',
            interpret: 'If present, this stage enforces a "risk window" and may hold tasks when budgets are exceeded.',
          },
          helios_risk_budget_count: {
            meaning: 'How many times risk budget evaluation completed.',
            units: 'runs',
            interpret: 'Use with risk_budget_seconds to estimate average time.',
          },
          helios_autonomy_seconds: {
            meaning: 'Total time spent applying autonomy / human-in-the-loop gating.',
            units: 'seconds (cumulative)',
            interpret: 'This reflects policy/approval workflow logic, not human time. If it grows, more tasks are being processed.',
          },
          helios_autonomy_count: {
            meaning: 'How many times autonomy gating logic completed.',
            units: 'runs',
            interpret: 'Use with autonomy_seconds to estimate average time.',
          },
          helios_export_seconds: {
            meaning: 'Total time spent exporting artifacts (events/tasks/suggestions/graph/STIX/etc.).',
            units: 'seconds (cumulative)',
            interpret: 'Increases with more artifacts written or slower disk/network.',
          },
          helios_export_count: {
            meaning: 'How many times export completed.',
            units: 'runs',
            interpret: 'Use with export_seconds to estimate average export time.',
          },

          // Common counters
          helios_events_raw: {
            meaning: 'How many raw events were produced by rules (before governance filtering).',
            units: 'events (cumulative)',
            interpret: 'Higher can mean more detections/noise; compare with governance/audit to see what was filtered.',
          },
          helios_export_json_writes: {
            meaning: 'How many JSON export artifacts were written into out/.',
            units: 'writes (cumulative)',
            interpret: 'Useful to confirm the pipeline is emitting outputs (events.json, suggestions, graph.json, etc.).',
          },

          // Guardrail drops (cumulative)
          helios_guardrail_drop_total: {
            meaning: 'How many candidate tasks were dropped due to total action limit.',
            units: 'tasks (cumulative)',
            interpret: 'If this rises, overall action volume is hitting the configured cap.',
          },
          helios_guardrail_drop_domain: {
            meaning: 'How many tasks were dropped due to per-domain action limits.',
            units: 'tasks (cumulative)',
            interpret: 'If this rises, a specific domain is producing too many actions vs its configured limit.',
          },
          helios_guardrail_drop_per_event: {
            meaning: 'How many tasks were dropped due to per-event action limits.',
            units: 'tasks (cumulative)',
            interpret: 'If this rises, single events are generating too many actions.',
          },
          helios_guardrail_drop_per_asset: {
            meaning: 'How many tasks were dropped due to per-asset limits.',
            units: 'tasks (cumulative)',
            interpret: 'If this rises, repeated actions are targeting the same asset.',
          },
          helios_guardrail_drop_per_asset_pattern: {
            meaning: 'How many tasks were dropped due to per-asset pattern limits.',
            units: 'tasks (cumulative)',
            interpret: 'If this rises, an asset-matching pattern is hitting its configured limit.',
          },

          // Export/infrastructure adapter counters (if enabled)
          helios_export_webhook_success: { meaning: 'Webhook export successes.', units: 'count (cumulative)', interpret: 'If configured, confirms remote forwarding worked.' },
          helios_export_webhook_failed: { meaning: 'Webhook export failures.', units: 'count (cumulative)', interpret: 'If this rises, check network/config/endpoint.' },
          helios_export_task_jsonl_writes: { meaning: 'Task JSONL export writes.', units: 'writes (cumulative)', interpret: 'Shows task export activity.' },
          helios_export_infrastructure_writes: { meaning: 'Infrastructure export writes (actions JSONL).', units: 'writes (cumulative)', interpret: 'Shows response handoff output activity.' },
          helios_export_stix_writes: { meaning: 'STIX bundle export writes.', units: 'writes (cumulative)', interpret: 'Shows STIX output activity (if enabled).' },
          helios_infra_file_writes: { meaning: 'Infrastructure adapter file writes.', units: 'writes (cumulative)', interpret: 'Confirms file exporter is writing actions.' },
          helios_infra_actions_written: { meaning: 'Total actions written by infrastructure adapter.', units: 'actions (cumulative)', interpret: 'Rises with actions emitted.' },
          helios_infra_http_success: { meaning: 'Infrastructure HTTP forward successes.', units: 'count (cumulative)', interpret: 'Confirms remote forwarding worked (if enabled).' },
          helios_infra_http_failed: { meaning: 'Infrastructure HTTP forward failures.', units: 'count (cumulative)', interpret: 'If this rises, check endpoint and credentials.' },
        };

        const describeMetric = (key) => METRIC_CATALOG[key] || {
          meaning: 'No description available for this metric name yet.',
          units: key.endsWith('_seconds') ? 'seconds (cumulative)' : 'count (cumulative)',
          interpret: 'If you want, we can add a description for this metric in the UI glossary.',
        };

        const renderExplain = (lookup, sourceLabel) => {
          if (!explain) return;
          const keys = Object.keys(lookup || {}).sort();
          const stageSeconds = keys.filter(k => k.startsWith('helios_') && k.endsWith('_seconds'));
          const stageCounts = keys.filter(k => k.startsWith('helios_') && k.endsWith('_count'));
          const hasTimers = stageSeconds.length > 0 && stageCounts.length > 0;
          explain.innerHTML = `<div class="nl">
            <div class="k">Source</div>
            <div class="v">${escapeHtml(sourceLabel)}</div>
            <ul class="nl-list">
              <li><strong>All values are cumulative</strong> since the server started. Restarting the server resets them.</li>
              <li>Each timed stage produces two metrics: <code>helios_&lt;stage&gt;_seconds</code> (total time) and <code>helios_&lt;stage&gt;_count</code> (how many runs).</li>
              <li>Average time per run is approximately <code>seconds / count</code>${hasTimers ? '' : ' (when both are present)'}.</li>
              <li>Counts like <code>helios_guardrail_drop_*</code> explain why actions were limited (proportionality/safety controls).</li>
            </ul>
          </div>
          <details class="nl-raw" style="margin-top:10px;">
            <summary>Glossary (what each metric means)</summary>
            <table class="table" style="margin-top:10px;">
              <tr><th>Metric</th><th>Meaning</th><th>Units</th><th>How to interpret</th></tr>
              ${keys.slice(0, 60).map(k => {
                const d = describeMetric(k);
                return `<tr><td>${escapeHtml(k)}</td><td>${escapeHtml(d.meaning)}</td><td>${escapeHtml(d.units)}</td><td>${escapeHtml(d.interpret)}</td></tr>`;
              }).join('')}
            </table>
            ${keys.length > 60 ? `<div class="muted" style="margin-top:8px;">Showing first 60 metrics.</div>` : ''}
          </details>`;
        };

        if (demoMode) {
          const demo = getDemoState();
          const lookup = demo.metrics || {};

          renderExplain(lookup, 'Demo Data (seeded metrics)');

          const kpiKeys = ['helios_events_raw', 'helios_decision_count', 'helios_export_json_writes', 'helios_guardrails_count'];
          if (kpi) {
            kpi.innerHTML = '';
            kpiKeys.forEach(key => {
              const label = key.replace('helios_', '').replace(/_/g, ' ');
              const val = lookup[key] ?? '—';
              const card = document.createElement('div');
              card.className = 'kpi';
              card.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
              kpi.appendChild(card);
            });
          }

          const counterKeys = [
            'helios_ingest_count',
            'helios_fusion_count',
            'helios_rules_count',
            'helios_events_raw',
            'helios_decision_count',
            'helios_guardrails_count',
            'helios_risk_budget_count',
            'helios_autonomy_count',
            'helios_export_json_writes',
          ];
          const timingKeys = [
            'helios_ingest_seconds',
            'helios_fusion_seconds',
            'helios_rules_seconds',
            'helios_decision_seconds',
            'helios_guardrails_seconds',
            'helios_risk_budget_seconds',
            'helios_autonomy_seconds',
          ];

          const renderCounters = (table, keys, emptyMsg) => {
            if (!table) return;
            if (!keys.length) {
              table.innerHTML = `<tr><td class="muted" colspan="4">${emptyMsg}</td></tr>`;
              return;
            }
            table.innerHTML = '<tr><th>Metric</th><th>Value</th><th>Meaning</th><th>How to interpret</th></tr>';
            keys.forEach(key => {
              const row = document.createElement('tr');
              const label = key.replace('helios_', '').replace(/_/g, ' ');
              const val = lookup[key];
              const d = describeMetric(key);
              row.innerHTML = `<td>${escapeHtml(label)}</td><td>${escapeHtml(val ?? '—')}</td><td>${escapeHtml(d.meaning)}</td><td>${escapeHtml(d.interpret)}</td>`;
              table.appendChild(row);
            });
          };

          const renderTimings = (table, keys, emptyMsg) => {
            if (!table) return;
            if (!keys.length) {
              table.innerHTML = `<tr><td class="muted" colspan="5">${emptyMsg}</td></tr>`;
              return;
            }
            table.innerHTML = '<tr><th>Stage</th><th>Total (s)</th><th>Runs</th><th>Avg (s/run)</th><th>Meaning</th></tr>';
            keys.forEach(key => {
              const row = document.createElement('tr');
              const label = key.replace('helios_', '').replace(/_seconds$/,'').replace(/_/g, ' ');
              const total = Number(lookup[key]);
              const countKey = key.replace(/_seconds$/, '_count');
              const runs = Number(lookup[countKey]);
              const avg = (isFinite(total) && isFinite(runs) && runs > 0) ? (total / runs) : null;
              const d = describeMetric(key);
              row.innerHTML = `<td>${escapeHtml(label)}</td><td>${escapeHtml(isFinite(total) ? total.toFixed(3) : (lookup[key] ?? '—'))}</td><td>${escapeHtml(isFinite(runs) ? runs : (lookup[countKey] ?? '—'))}</td><td>${escapeHtml(avg === null ? '—' : avg.toFixed(3))}</td><td>${escapeHtml(d.meaning)}</td>`;
              table.appendChild(row);
            });
          };

          renderCounters(countersTable, counterKeys, 'No counters');
          renderTimings(timingsTable, timingKeys, 'No timings');
          return;
        }

        const res = await fetch('/api/metrics');
        if (!res.ok) throw new Error('metrics not found');
        const text = await res.text();
        const lines = text.trim().split('\n').filter(Boolean);
        const metrics = lines.map(line => {
          const [name, val] = line.trim().split(/\s+/);
          const num = Number(val);
          return { name, val: isNaN(num) ? val : num };
        });

        const lookup = Object.fromEntries(metrics.map(m => [m.name, m.val]));

        renderExplain(lookup, 'Live metrics (/api/metrics)');
        const kpiKeys = ['helios_events_raw', 'helios_decision_count', 'helios_export_json_writes', 'helios_guardrails_count'];
        if (kpi) {
          kpi.innerHTML = '';
          kpiKeys.forEach(key => {
            const label = key.replace('helios_', '').replace(/_/g, ' ');
            const val = lookup[key] ?? '—';
            const card = document.createElement('div');
            card.className = 'kpi';
            card.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
            kpi.appendChild(card);
          });
        }

        const counterKeys = [
          'helios_ingest_count',
          'helios_fusion_count',
          'helios_rules_count',
          'helios_events_raw',
          'helios_decision_count',
          'helios_guardrails_count',
          'helios_risk_budget_count',
          'helios_autonomy_count',
          'helios_export_json_writes',
        ];
        const timingKeys = [
          'helios_ingest_seconds',
          'helios_fusion_seconds',
          'helios_rules_seconds',
          'helios_decision_seconds',
          'helios_guardrails_seconds',
          'helios_risk_budget_seconds',
          'helios_autonomy_seconds',
        ];

        const renderCounters = (table, keys, emptyMsg) => {
          if (!table) return;
          if (!keys.length) {
            table.innerHTML = `<tr><td class="muted" colspan="4">${emptyMsg}</td></tr>`;
            return;
          }
          table.innerHTML = '<tr><th>Metric</th><th>Value</th><th>Meaning</th><th>How to interpret</th></tr>';
          keys.forEach(key => {
            const row = document.createElement('tr');
            const label = key.replace('helios_', '').replace(/_/g, ' ');
            const val = lookup[key];
            const d = describeMetric(key);
            row.innerHTML = `<td>${escapeHtml(label)}</td><td>${escapeHtml(val ?? '—')}</td><td>${escapeHtml(d.meaning)}</td><td>${escapeHtml(d.interpret)}</td>`;
            table.appendChild(row);
          });
        };

        const renderTimings = (table, keys, emptyMsg) => {
          if (!table) return;
          if (!keys.length) {
            table.innerHTML = `<tr><td class="muted" colspan="5">${emptyMsg}</td></tr>`;
            return;
          }
          table.innerHTML = '<tr><th>Stage</th><th>Total (s)</th><th>Runs</th><th>Avg (s/run)</th><th>Meaning</th></tr>';
          keys.forEach(key => {
            const row = document.createElement('tr');
            const label = key.replace('helios_', '').replace(/_seconds$/,'').replace(/_/g, ' ');
            const total = Number(lookup[key]);
            const countKey = key.replace(/_seconds$/, '_count');
            const runs = Number(lookup[countKey]);
            const avg = (isFinite(total) && isFinite(runs) && runs > 0) ? (total / runs) : null;
            const d = describeMetric(key);
            row.innerHTML = `<td>${escapeHtml(label)}</td><td>${escapeHtml(isFinite(total) ? total.toFixed(3) : (lookup[key] ?? '—'))}</td><td>${escapeHtml(isFinite(runs) ? runs : (lookup[countKey] ?? '—'))}</td><td>${escapeHtml(avg === null ? '—' : avg.toFixed(3))}</td><td>${escapeHtml(d.meaning)}</td>`;
            table.appendChild(row);
          });
        };

        renderCounters(countersTable, counterKeys, 'No counters');
        renderTimings(timingsTable, timingKeys, 'No timings');
      } catch (e) {
        if (kpi) kpi.innerHTML = '';
        if (countersTable) countersTable.innerHTML = '<tr><td class="muted" colspan="4">metrics.prom not found</td></tr>';
        if (timingsTable) timingsTable.innerHTML = '<tr><td class="muted" colspan="5">metrics.prom not found</td></tr>';
        if (explain) explain.textContent = 'Metrics not available yet. Run the pipeline to generate out/metrics.prom.';
      }
    }

    async function loadConfig() {
      try {
        if (demoMode) {
          const demo = getDemoState();
          guardrailCfgCache = demo.cfg;
          renderApprovals(demo.cfg);
          renderGuardrails(demo.cfg);
          renderInfra(demo.cfg);
          renderModules(demo.cfg);
          return;
        }
        const res = await fetch('/api/config');
        const text = await res.text();
        const cfg = jsyaml.load(text);
        guardrailCfgCache = cfg;
        renderApprovals(cfg);
        renderGuardrails(cfg);
        renderInfra(cfg);
        renderModules(cfg);
      } catch (e) {
        console.error('Config load failed', e);
      }
    }

    async function loadEvents() {
      try {
        if (demoMode) {
          const demo = getDemoState();
          const events = demo.events || [];
          const tasks = demo.tasks || [];
          document.getElementById('events-count').textContent = events.length;
          document.getElementById('tasks-count').textContent = tasks.length;
          renderEventsTasks(events, tasks);
          return;
        }
        const res = await fetch('/api/events');
        if (!res.ok) throw new Error('events not found');
        const data = await res.json();
        const events = data.events || [];
        const tasks = data.tasks || [];
        document.getElementById('events-count').textContent = events.length;
        document.getElementById('tasks-count').textContent = tasks.length;
        renderEventsTasks(events, tasks);
      } catch (e) {
        document.getElementById('events-preview').innerHTML = '<li>No events.json yet. Run the pipeline or modules_media ingest.</li>';
      }
    }

    async function loadAudit(tailOverride) {
      const tail = tailOverride || Number(document.getElementById('audit-tail')?.value || 120);
      try {
        if (demoMode) {
          const demo = getDemoState();
          latestAudit = (demo.audit || []).slice(-tail);
          renderAuditPreview(latestAudit.slice(-10));
          renderModulesStats();
          renderAuditSummaries();
          renderAuditTable();
          renderGuardrails();
          loadActionSuggestion();
          return;
        }
        const res = await fetch(`/api/audit?tail=${tail}`);
        if (!res.ok) throw new Error('audit not found');
        const data = await res.json();
        latestAudit = data.audit || [];
        renderAuditPreview(latestAudit.slice(-10));
        renderModulesStats();
        renderAuditSummaries();
        renderAuditTable();
        renderGuardrails();
        loadActionSuggestion();
      } catch (e) {
        latestAudit = [];
        moduleStatsCache = null;
        document.getElementById('audit-preview').innerHTML = '<li>No audit_log.jsonl yet.</li>';
        document.getElementById('modules-run-meta').textContent = 'Waiting for audit...';
        document.getElementById('modules-run-stats').textContent = 'No ingest run recorded yet. Run pipeline with ingest.mode: modules_media.';
        renderAuditSummaries(true);
        renderAuditTable(true);
        renderModuleDetails();
        renderGuardrails();
      }
    }

    async function loadActionSuggestion() {
      try {
        if (demoMode) {
          const demo = getDemoState();
          renderActionSuggestion(demo.suggestion);
          return;
        }
        const res = await fetch('/api/action_suggestion');
        if (!res.ok) throw new Error('suggestion not found');
        const data = await res.json();
        renderActionSuggestion(data);
      } catch (e) {
        renderActionSuggestion(null, true);
      }
    }

    function renderApprovals(cfg) {
      const actionDefaults = cfg?.pipeline?.infrastructure?.action_defaults || {};
      const rbacActions = cfg?.pipeline?.rbac?.action_requirements || {};
      const container = document.getElementById('approvals-content');
      container.innerHTML = '';
      Object.entries({ ...actionDefaults, ...rbacActions }).forEach(([action, vals]) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h3>${action}</h3>
          <div class="status-row"><span>Required Roles</span><span class="muted small">${(vals.required_roles || []).join(', ') || 'none'}</span></div>
          <div class="status-row"><span>Min Approvals</span><span class="muted small">${vals.min_approvals ?? 0}</span></div>
          <div class="status-row"><span>Status</span><span class="badge badge-live">Implemented</span></div>`;
        container.appendChild(card);
      });
      if (!container.childElementCount) {
        container.innerHTML = '<div class="card"><h3>No action defaults</h3><div class="muted">Add under pipeline.infrastructure.action_defaults.</div></div>';
      }
    }

    function renderGuardrails(cfg) {
      const source = cfg || guardrailCfgCache;
      const rate = source?.pipeline?.guardrails?.rate_limits || {};
      const riskBudgets = source?.pipeline?.guardrails?.risk_budgets || {};
      const healthThreshold = source?.pipeline?.guardrails?.health_alert_drop_ratio;
      const grid = document.getElementById('guardrails-cards');
      if (!grid) return;
      grid.innerHTML = '';

      const cards = [
        {
          title: 'Rate Limits',
          body: [
            ['Per Domain', rate.per_domain],
            ['Per Event', rate.per_event],
            ['Total', rate.total],
            ['Per Asset', rate.per_asset_infra],
            ['Per Asset Pattern', rate.per_asset_infra_patterns],
          ],
        },
        {
          title: 'Risk Budgets',
          body: Object.keys(riskBudgets).length
            ? Object.entries(riskBudgets).map(([tenant, vals]) => [tenant, vals])
            : [['None configured', '']],
        },
        {
          title: 'Health Alerts',
          body: [['Drop ratio alert threshold', healthThreshold ?? 'unset']],
        },
      ];

      cards.forEach(({ title, body }) => {
        const card = document.createElement('div');
        card.className = 'card';
        const rows = body.map(([label, val]) => {
          const display = typeof val === 'object' ? JSON.stringify(val, null, 2) : (val ?? 'unset');
          return `<div class="status-row"><span>${label}</span><span class="muted small">${display}</span></div>`;
        }).join('');
        card.innerHTML = `<h3>${title}</h3>${rows}<div class="status-row"><span>Status</span><span class="badge badge-live">Implemented</span></div>`;
        grid.appendChild(card);
      });
    }

    function renderInfra(cfg) {
      const infra = cfg?.pipeline?.export?.infrastructure || {};
      const path = infra.path || 'out/infrastructure_actions.jsonl';
      const el = document.getElementById('infra-file-status');
      const raw = document.getElementById('infra-file-status-raw');
      const sourceLabel = demoMode ? 'Demo Data (seeded config)' : 'Live config (/api/config)';
      if (el) {
        el.innerHTML = `<div class="nl">
          <div class="k">Exporter</div>
          <div class="v">Infrastructure actions file</div>
          <ul class="nl-list">
            <li>Path: ${escapeHtml(path)}</li>
            <li>Rotation: ${escapeHtml(infra.rotate_max_bytes || 'none')}</li>
            <li>HTTP forwarding: ${escapeHtml(infra.http ? 'configured' : 'not configured')}</li>
            <li>Source: ${escapeHtml(sourceLabel)}</li>
          </ul>
        </div>`;
      }
      if (raw) raw.textContent = JSON.stringify(infra, null, 2);
    }

    function renderModules(cfg) {
      const ingest = cfg?.pipeline?.ingest || {};
      const modules = ingest.modules || {};
      const media = ingest.media || {};
      modulesCfgCache = { modules, media, ingest };
      const grid = document.getElementById('modules-config');
      grid.innerHTML = '';

      const nav = document.getElementById('module-nav');
      if (nav) {
        nav.innerHTML = '';
        Object.entries(moduleCatalog).forEach(([key, meta]) => {
          const enabled = Boolean(modules[`enable_${key}`] ?? (key === 'gait' ? modules.enable_gait : false));
          const btn = document.createElement('button');
          btn.className = `chip ${selectedModule === key ? 'active' : ''}`;
          btn.dataset.module = key;
          btn.textContent = meta.title;
          if (!enabled) btn.style.opacity = 0.55;
          btn.addEventListener('click', () => {
            selectedModule = key;
            updateModuleNavActive();
            renderModuleDetails();
          });
          nav.appendChild(btn);
        });
        updateModuleNavActive();
      }

      const modeCard = document.createElement('div');
      modeCard.className = 'card';
      modeCard.innerHTML = `<h3>Ingest Mode</h3>
        <div class="status-row"><span>Mode</span><span class="badge ${ingest.mode === 'modules_media' ? 'badge-live' : 'badge-mock'}">${ingest.mode || 'unset'}</span></div>
        <div class="status-row"><span>Media Path</span><span class="muted small">${media.path || 'examples/scenario_minimal.yaml'}</span></div>
        <div class="status-row"><span>Stride</span><span class="muted small">${media.stride ?? 8}</span></div>`;
      grid.appendChild(modeCard);

      const toggles = ['enable_vision', 'enable_audio', 'enable_thermal', 'enable_gait', 'enable_scene'];
      const togglesCard = document.createElement('div');
      togglesCard.className = 'card';
      togglesCard.innerHTML = `<h3>Modules Enabled</h3>${toggles.map(name => {
        const on = Boolean(modules[name]);
        return `<div class="status-row"><span>${name.replace('enable_', '').toUpperCase()}</span><span class="badge ${on ? 'badge-live' : 'badge-mock'}">${on ? 'on' : 'off'}</span></div>`;
      }).join('')}`;
      grid.appendChild(togglesCard);

      const tuningCard = document.createElement('div');
      tuningCard.className = 'card';
      tuningCard.innerHTML = `<h3>Sampling</h3>
        <div class="status-row"><span>Downscale</span><span class="muted small">${modules.downscale ?? 1}</span></div>
        <div class="status-row"><span>Notes</span><span class="muted small">Stride/downscale impact frame and audio hop selection.</span></div>`;
      grid.appendChild(tuningCard);

      renderModuleDetails();
      renderModulesStats();
    }

    function updateModuleNavActive() {
      const nav = document.getElementById('module-nav');
      if (!nav) return;
      nav.querySelectorAll('.chip').forEach(chip => {
        const key = chip.dataset.module;
        chip.classList.toggle('active', key === selectedModule);
      });
    }

    function renderModuleDetails() {
      const container = document.getElementById('module-details');
      if (!container) return;
      const modules = modulesCfgCache.modules || {};
      const media = modulesCfgCache.media || {};
      const key = moduleCatalog[selectedModule] ? selectedModule : Object.keys(moduleCatalog)[0];
      const meta = moduleCatalog[key];
      const enabled = Boolean(modules[`enable_${key}`] ?? (key === 'gait' ? modules.enable_gait : false));
      const stats = (moduleStatsCache && moduleStatsCache.stats) || {};
      const count = stats[key] ?? 0;
      const ingestPath = (moduleStatsCache && moduleStatsCache.path) || media.path || 'n/a';
      const stride = (moduleStatsCache && moduleStatsCache.stride) ?? media.stride ?? 8;
      const outputs = (meta.outputs || []).join(' · ');

      container.innerHTML = `<h3>${meta.title}</h3>
        <p class="muted">${meta.desc}</p>
        <div class="status-row"><span>Status</span><span class="badge ${enabled ? 'badge-live' : 'badge-mock'}">${enabled ? 'enabled' : 'disabled'}</span></div>
        <div class="status-row"><span>Last outputs</span><span class="muted small">${count ? `${count} fragments` : 'n/a'}</span></div>
        <div class="status-row"><span>Media path</span><span class="muted small">${ingestPath}</span></div>
        <div class="status-row"><span>Stride</span><span class="muted small">${stride}</span></div>
        <div class="status-row"><span>Outputs</span><span class="muted small">${outputs || '—'}</span></div>`;
    }

    function renderActionSuggestion(data, empty = false) {
      const statusEl = document.getElementById('action-status');
      const pre = document.getElementById('action-preview');
      if (!statusEl || !pre) return;
      if (empty || !data) {
        statusEl.textContent = 'missing';
        statusEl.className = 'badge badge-mock';
        pre.innerHTML = '<li>No action suggestion available yet. Run modules_media or pipeline to generate.</li>';
        return;
      }
      statusEl.textContent = data.status || 'proposed';
      statusEl.className = `badge ${data.status === 'approved' ? 'badge-live' : data.status === 'denied' ? 'badge-mock' : 'badge-live'}`;
      const lines = [];
      lines.push(`Proposed at ${new Date((data.proposed_at || Date.now()) * 1000).toLocaleString()}`);
      if (data.plain_text) lines.push(`Plan: ${data.plain_text}`);
      if (data.recommended) {
        lines.push(`Action: ${data.recommended.action || 'action'} on ${data.recommended.asset_id || 'asset'} (${data.recommended.infrastructure_type || 'infra'}) domain ${data.recommended.assignee_domain || 'n/a'}`);
      }
      if (data.summary) {
        lines.push(`Context: ${data.summary.events_seen || 0} events, ${data.summary.tasks_approved || 0} approved tasks`);
      }
      if (data.decided_by) {
        lines.push(`Decision by ${data.decided_by}: ${data.status} (${data.decision_rationale || 'no rationale'})`);
      }
      pre.innerHTML = lines.map(t => `<li>${t}</li>`).join('');
    }

    function renderEventsTasks(events, tasks) {
      const list = document.getElementById('events-preview');
      if (!list) return;
      list.innerHTML = '';
      const topEvents = events.slice(0, 5);
      const topTasks = tasks.slice(0, 5);
      if (!topEvents.length && !topTasks.length) {
        list.innerHTML = '<li>No events or tasks yet.</li>';
        return;
      }
      topEvents.forEach(ev => {
        const li = document.createElement('li');
        const when = ev.ts_ms ? new Date(ev.ts_ms).toLocaleString() : 'recent';
        li.textContent = `[Event] ${ev.category || ev.id || 'unknown'} in ${ev.domain || 'domain'} (sev ${ev.severity_label || ev.severity || '?'}) at ${when}`;
        list.appendChild(li);
      });
      topTasks.forEach(t => {
        const li = document.createElement('li');
        li.textContent = `[Task] ${t.action || 'action'} -> ${t.asset_id || 'asset'} (${t.infrastructure_type || 'infra'}) domain ${t.assignee_domain || 'n/a'} status ${t.status || 'pending'}`;
        list.appendChild(li);
      });
    }

    function renderAuditPreview(entries) {
      const list = document.getElementById('audit-preview');
      if (!list) return;
      list.innerHTML = '';
      if (!entries || !entries.length) {
        list.innerHTML = '<li>No audit entries.</li>';
        return;
      }
      entries.forEach(evt => {
        const li = document.createElement('li');
        const ts = evt.ts_unix ? new Date(evt.ts_unix * 1000).toLocaleString() : '';
        li.textContent = `${ts}: ${evt.kind} — ${summarizeAuditPayload(evt)}`;
        list.appendChild(li);
      });
    }

    function summarizeAuditPayload(evt) {
      const kind = evt.kind;
      const p = evt.payload || {};
      switch (kind) {
        case 'ingest_modules_done':
          return `modules_media path ${p.path} stride ${p.stride} stats ${JSON.stringify(p.stats)}`;
        case 'rules_done':
          return `events ${p.events}, after governance ${p.events_after_governance}, blocked ${p.blocked}`;
        case 'guardrails':
          return `kept ${p.kept || 0} (drops ${JSON.stringify(p)})`;
        case 'action_suggestion':
          return `suggested ${p.recommended?.action || 'action'} for ${p.recommended?.asset_id || 'asset'} status ${p.status}`;
        case 'action_suggestion_decision':
          return `decision ${p.decision} for ${p.suggestion_id}`;
        default:
          return JSON.stringify(p);
      }
    }

    function renderModulesStats() {
      if (!Array.isArray(latestAudit) || !latestAudit.length) return;
      const ingestEvent = [...latestAudit].reverse().find(evt => evt.kind === 'ingest_modules_done');
      if (!ingestEvent) return;
      const payload = ingestEvent.payload || {};
      const stats = payload.stats || {};
      const summary = {
        path: payload.path,
        stride: payload.stride,
        modules_seen: Object.keys(stats).length,
      };
      moduleStatsCache = { stats, path: payload.path, stride: payload.stride, ts: ingestEvent.ts_unix, seq: ingestEvent.seq };
      document.getElementById('modules-run-meta').textContent = `seq ${ingestEvent.seq} · ${new Date(ingestEvent.ts_unix * 1000).toLocaleString()}`;
      const el = document.getElementById('modules-run-stats');
      const raw = document.getElementById('modules-run-stats-raw');
      const modulesList = Object.entries(stats)
        .sort((a, b) => (b[1] ?? 0) - (a[1] ?? 0))
        .slice(0, 8)
        .map(([k, v]) => `${k}: ${v}`);
      if (el) {
        el.innerHTML = `<div class="nl">
          <div class="k">What happened</div>
          <div class="v">Modules ingest completed</div>
          <ul class="nl-list">
            <li>Input: ${escapeHtml(payload.path || '—')}</li>
            <li>Stride: ${escapeHtml(payload.stride ?? '—')}</li>
            <li>Modules with output: ${escapeHtml(Object.keys(stats).length)}</li>
            <li>Top outputs: ${escapeHtml(modulesList.length ? modulesList.join(' · ') : '—')}</li>
          </ul>
        </div>`;
      }
      if (raw) raw.textContent = JSON.stringify({ summary, modules: stats }, null, 2);
      renderModuleDetails();
    }

    function renderAuditSummaries(empty = false) {
      const grid = document.getElementById('audit-summaries');
      if (!grid) return;
      grid.innerHTML = '';
      if (empty || !latestAudit.length) {
        grid.innerHTML = '<div class="card"><h3>No audit yet</h3><div class="muted">Run the pipeline to generate audit_log.jsonl.</div></div>';
        return;
      }
      const last = latestAudit[latestAudit.length - 1];
      const kinds = latestAudit.reduce((acc, evt) => {
        acc[evt.kind] = (acc[evt.kind] || 0) + 1;
        return acc;
      }, {});
      const kindList = Object.entries(kinds).sort((a, b) => b[1] - a[1]).slice(0, 4);
      const summaryCard = document.createElement('div');
      summaryCard.className = 'card';
      summaryCard.innerHTML = `<h3>Overview</h3>
        <div class="status-row"><span>Total entries</span><span class="muted small">${latestAudit.length}</span></div>
        <div class="status-row"><span>Last kind</span><span class="muted small">${last.kind}</span></div>
        <div class="status-row"><span>Latest seq</span><span class="muted small">${last.seq}</span></div>
        <div class="status-row"><span>Last time</span><span class="muted small">${new Date(last.ts_unix * 1000).toLocaleString()}</span></div>`;
      grid.appendChild(summaryCard);

      const kindsCard = document.createElement('div');
      kindsCard.className = 'card';
      kindsCard.innerHTML = `<h3>Top kinds</h3>${kindList.map(([k, v]) => `<div class="status-row"><span>${k}</span><span class="muted small">${v}</span></div>`).join('')}`;
      grid.appendChild(kindsCard);
    }

    function renderAuditTable(empty = false) {
      const table = document.getElementById('audit-table');
      if (!table) return;
      if (empty || !latestAudit.length) {
        table.innerHTML = '<tr><td class="muted" colspan="5">No audit entries yet.</td></tr>';
        return;
      }
      table.innerHTML = '<tr><th>Seq</th><th>Kind</th><th>Actor</th><th>Time</th><th>Description</th></tr>';
      latestAudit.slice().reverse().forEach(evt => {
        const row = document.createElement('tr');
        const desc = summarizeAuditPayload(evt);
        row.innerHTML = `<td>${evt.seq}</td><td>${evt.kind}</td><td>${evt.actor || 'n/a'}</td><td>${new Date(evt.ts_unix * 1000).toLocaleString()}</td><td>${desc}</td>`;
        table.appendChild(row);
      });
    }

    document.getElementById('mock-send').addEventListener('click', () => {
      const payload = [{ id: 'mock1', action: 'lock', asset_id: 'demo_gate', infrastructure_type: 'gate' }];
      document.getElementById('mock-result').textContent = 'Sending...';
      setTimeout(() => {
        document.getElementById('mock-result').textContent = 'Mock send recorded locally (no network).';
      }, 400);
    });

    const auditRefreshBtn = document.getElementById('audit-refresh');
    if (auditRefreshBtn) {
      auditRefreshBtn.addEventListener('click', () => loadAudit());
    }
    const auditDownloadBtn = document.getElementById('audit-download');
    if (auditDownloadBtn) {
      auditDownloadBtn.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(latestAudit, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'audit_log_tail.json';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    const approveBtn = document.getElementById('action-approve');
    const denyBtn = document.getElementById('action-deny');
    const decide = async (decision) => {
      const actor = document.getElementById('action-actor')?.value || 'human';
      const token = document.getElementById('action-token')?.value || '';
      const rationale = document.getElementById('action-rationale')?.value || '';
      try {
        if (demoMode) {
          const demo = getDemoState();
          if (!demo.suggestion) demo.suggestion = { id: demoId('suggestion'), proposed_at: Math.floor(Date.now() / 1000), status: 'proposed' };
          demo.suggestion.status = decision === 'approve' ? 'approved' : 'denied';
          demo.suggestion.decided_at = Date.now() / 1000;
          demo.suggestion.decided_by = actor;
          demo.suggestion.decision_rationale = rationale;
          demo.audit = Array.isArray(demo.audit) ? demo.audit : [];
          const nextSeq = (demo.audit.length ? demo.audit[demo.audit.length - 1].seq : 0) + 1;
          demo.audit.push({
            seq: nextSeq,
            ts_unix: Math.floor(Date.now() / 1000),
            kind: 'action_suggestion_decision',
            actor,
            payload: { decision, rationale, suggestion_id: demo.suggestion.id },
          });
          renderActionSuggestion(demo.suggestion);
          loadAudit();
          return;
        }

        const res = await fetch('/api/action_suggestion', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ decision, actor, token, rationale }),
        });
        if (!res.ok) throw new Error('decision failed');
        const data = await res.json();
        renderActionSuggestion(data.suggestion);
        loadAudit();
      } catch (e) {
        alert('Failed to record decision.');
      }
    };
    if (approveBtn) approveBtn.addEventListener('click', () => decide('approve'));
    if (denyBtn) denyBtn.addEventListener('click', () => decide('deny'));

    // -------------------- Guided Tour (tutorial + simulation) --------------------
    (function setupGuidedTour() {
      const startBtn = document.getElementById('tour-start');
      if (!startBtn) return;

      let overlay = null;
      let card = null;
      let stepIndex = 0;
      let highlightedEl = null;
      let simulateMode = true; // default: no server writes

      function ensureOverlay() {
        if (overlay && card) return;
        overlay = document.createElement('div');
        overlay.className = 'tour-overlay';
        overlay.id = 'tour-overlay';
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) stopTour();
        });

        card = document.createElement('div');
        card.className = 'tour-card';
        card.innerHTML = `
          <div class="tour-title" id="tour-title">Guided Tour</div>
          <div class="tour-body" id="tour-body">Welcome.</div>
          <div class="tour-actions">
            <button class="pill-button" id="tour-back">Back</button>
            <button class="pill-button" id="tour-next">Next</button>
            <button class="pill-button" id="tour-exit">Exit</button>
          </div>
          <div class="tour-mini">
            <div id="tour-progress">Step 1/1</div>
            <label class="tour-toggle"><input type="checkbox" id="tour-sim" checked /> Simulate (no server writes)</label>
          </div>
        `;
        overlay.appendChild(card);
        document.body.appendChild(overlay);

        card.querySelector('#tour-exit')?.addEventListener('click', stopTour);
        card.querySelector('#tour-back')?.addEventListener('click', () => go(-1));
        card.querySelector('#tour-next')?.addEventListener('click', () => go(1));
        card.querySelector('#tour-sim')?.addEventListener('change', (e) => {
          simulateMode = Boolean(e.target.checked);
        });
      }

      function clearHighlight() {
        if (highlightedEl) highlightedEl.classList.remove('tour-highlight');
        highlightedEl = null;
      }

      function highlight(selector) {
        clearHighlight();
        if (!selector) return;
        const el = document.querySelector(selector);
        if (!el) return;
        highlightedEl = el;
        el.classList.add('tour-highlight');
        try {
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } catch (_) {
          // ignore
        }
      }

      function navigateTo(hash) {
        if (!hash) return;
        const link = document.querySelector(`nav a[href="${hash}"]`);
        if (link) link.click();
        else window.location.hash = hash;
      }

      function setTourText(title, body) {
        card.querySelector('#tour-title').textContent = title;
        card.querySelector('#tour-body').innerHTML = body;
        card.querySelector('#tour-progress').textContent = `Step ${stepIndex + 1}/${steps.length}`;
      }

      function demoEventsAndActions() {
        // Populate Live Feed with friendly sample content.
        const events = [
          {
            id: 'ev-demo-001',
            category: 'perimeter_anomaly',
            severity: 'warning',
            status: 'open',
            domain: 'facility',
            summary: 'Unusual movement detected near the north fence line',
            time_window: { start_ms: Date.now() - 120000, end_ms: Date.now() },
            entities: ['ent-demo-01'],
            sources: ['camera:north-fence'],
            tags: ['perimeter', 'after-hours'],
            evidence: [{ kind: 'CCTVClip', description: 'Short clip from north fence camera', uri: 'out/demo_clip.mp4' }],
          },
          {
            id: 'ev-demo-002',
            category: 'possible_tailgating',
            severity: 'notice',
            status: 'open',
            domain: 'access',
            summary: 'Door access pattern suggests possible tailgating',
            time_window: { start_ms: Date.now() - 300000, end_ms: Date.now() - 240000 },
            entities: [],
            sources: ['badge:door-A'],
            tags: ['access'],
            evidence: [],
          },
        ];
        const tasks = [
          {
            id: 'task-demo-001',
            event_id: 'ev-demo-001',
            action: 'dispatch_patrol',
            assignee_domain: 'security',
            priority: 3,
            rationale: 'Confirm area is clear and deter intrusion.',
            confidence: 0.74,
            status: 'approved',
            asset_id: 'north_fence',
            infrastructure_type: 'patrol',
          },
        ];
        renderEventsTasks(events, tasks);
        renderActionSuggestion({
          id: `suggestion-demo-${Date.now()}`,
          proposed_at: Date.now() / 1000,
          status: 'proposed',
          recommended: {
            action: 'dispatch_patrol',
            asset_id: 'north_fence',
            infrastructure_type: 'patrol',
            assignee_domain: 'security',
            rationale: 'Confirm area is clear and deter intrusion.',
          },
          summary: {
            events_seen: events.length,
            tasks_approved: tasks.length,
            tasks_pending: 0,
            top_event: { id: 'ev-demo-001', category: 'perimeter_anomaly', domain: 'facility', severity: 'warning' },
          },
          plain_text: 'Send a patrol to the north fence line and continue observation.',
        });
        document.getElementById('audit-preview').innerHTML = '<li>Demo: New activity received (simulated).</li><li>Demo: Recommendation prepared (simulated).</li>';
      }

      function demoCasebook() {
        // Populate the Casebook snapshot area with a safe example.
        const pre = document.getElementById('casebook-json');
        const meta = document.getElementById('casebook-meta');
        if (!pre || !meta) return;
        const cb = {
          schema_version: '0.1',
          cases: [{ id: 'case-demo-01', title: 'Night perimeter anomaly', description: 'Track repeated movement near north fence.', status: 'open', opened_at: Date.now() / 1000, domain: 'facility', classification: 'CUI' }],
          evidence: [{ id: 'ev-demo-01', kind: 'CCTVClip', description: 'North fence clip (simulated)', source: 'operator', created_at: Date.now() / 1000, uri: 'out/demo_clip.mp4', case_ids: ['case-demo-01'], tags: ['perimeter'], classification: 'CUI' }],
          hypotheses: [{ id: 'hyp-demo-01', title: 'Fence probing', description: 'Movement indicates probing for weak points.', status: 'open', confidence: 0.35, rationale: 'Repeated movement without entry attempt.', created_at: Date.now() / 1000, updated_at: Date.now() / 1000, case_ids: ['case-demo-01'], evidence_ids: ['ev-demo-01'], classification: 'CUI' }],
        };
        meta.textContent = `Demo casebook: ${cb.cases.length} case(s) · ${cb.evidence.length} evidence item(s) · ${cb.hypotheses.length} hypothesis/hypotheses.`;
        pre.textContent = JSON.stringify(cb, null, 2);
        try {
          window.__casebookSelectedId = cb.cases?.[0]?.id;
          renderCasebookReadable(cb);
        } catch (_) {
          // ignore
        }
      }

      function demoGraph() {
        const meta = document.getElementById('graph-meta');
        if (!meta) return;
        const graph = {
          schema_version: '0.1',
          generated_at: new Date().toISOString(),
          nodes: [
            { id: 'event:ev-demo-001', type: 'event', label: 'Unusual movement near north fence', props: { severity: 'warning', domain: 'facility' } },
            { id: 'task:task-demo-001', type: 'task', label: 'dispatch_patrol', props: { status: 'approved' } },
            { id: 'case:case-demo-01', type: 'case', label: 'Night perimeter anomaly', props: { status: 'open' } },
            { id: 'evidence:ev-demo-01', type: 'evidence', label: 'North fence clip (simulated)', props: { kind: 'CCTVClip' } },
          ],
          edges: [
            { source: 'task:task-demo-001', type: 'RESPONDS_TO', target: 'event:ev-demo-001', props: {} },
            { source: 'evidence:ev-demo-01', type: 'EVIDENCE_FOR', target: 'case:case-demo-01', props: {} },
          ],
          stats: { nodes: 4, edges: 2, node_types: ['case', 'evidence', 'event', 'task'], edge_types: ['EVIDENCE_FOR', 'RESPONDS_TO'] },
        };
        window.__heliosGraph = graph;
        renderGraph(graph);
      }

      const steps = [
        {
          title: 'Welcome to Helios',
          body: 'This tour shows a typical workflow: <b>check activity</b>, <b>review safety</b>, <b>investigate</b>, and <b>act</b>. You can exit anytime.',
          go: () => { navigateTo('#dashboard'); highlight('#tour-start'); },
        },
        {
          title: 'Overview',
          body: 'Use <b>Overview</b> to get a quick sense of system health and speed.',
          go: () => { navigateTo('#dashboard'); highlight('#card-counters'); },
        },
        {
          title: 'Live feed (simulated)',
          body: 'This is where you see what was detected and the recommended response. During the tour we can simulate a recent run.',
          go: () => {
            navigateTo('#data');
            highlight('#events-preview');
            if (simulateMode) {
              setTimeout(demoEventsAndActions, 250);
            }
          },
        },
        {
          title: 'Review & approve',
          body: 'Use <b>Review</b> to confirm who can approve actions and what needs sign-off.',
          go: () => { navigateTo('#approvals'); highlight('#approvals-content'); },
        },
        {
          title: 'Safety controls',
          body: 'Use <b>Safety</b> to keep actions proportional (rate limits, per-asset limits, etc.).',
          go: () => { navigateTo('#guardrails'); highlight('#guardrails-cards'); },
        },
        {
          title: 'Investigations',
          body: 'Use <b>Investigate</b> to organize what you’ve seen into a case, attach evidence, and track hypotheses.',
          go: () => {
            navigateTo('#intel');
            highlight('#intel-nav');
            if (typeof initIntelUI === 'function') initIntelUI();
          },
        },
        {
          title: 'Casebook (simulated)',
          body: 'Here’s an example casebook entry. In simulation mode this does not write anything to disk.',
          go: () => {
            navigateTo('#intel');
            if (typeof initIntelUI === 'function') initIntelUI();
            selectedIntelTab = 'casebook';
            if (typeof updateIntelNavActive === 'function') updateIntelNavActive();
            if (typeof showIntelTab === 'function') showIntelTab('casebook');
            highlight('#casebook-readable');
            if (simulateMode) setTimeout(demoCasebook, 200);
          },
        },
        {
          title: 'Graph view (simulated)',
          body: 'The <b>Graph</b> view connects events, actions, cases, and evidence so relationships are easy to follow.',
          go: () => {
            navigateTo('#intel');
            if (typeof initIntelUI === 'function') initIntelUI();
            selectedIntelTab = 'graph';
            if (typeof updateIntelNavActive === 'function') updateIntelNavActive();
            if (typeof showIntelTab === 'function') showIntelTab('graph');
            highlight('#graph-nodes');
            if (simulateMode) setTimeout(demoGraph, 200);
          },
        },
        {
          title: 'Respond',
          body: 'Finally, <b>Respond</b> shows how actions would be handed off (this demo uses local files + a mock trigger).',
          go: () => { navigateTo('#infrastructure'); highlight('#mock-send'); },
        },
        {
          title: 'You’re done',
          body: 'Run a real scenario to see live data flow through the same pages. Tip: keep this tour handy for onboarding new operators.',
          go: () => { navigateTo('#dashboard'); clearHighlight(); },
        },
      ];

      function showStep() {
        ensureOverlay();
        overlay.classList.add('active');
        const s = steps[stepIndex];
        setTourText(s.title, s.body);
        clearHighlight();
        try { s.go(); } catch (_) { /* ignore */ }

        const back = card.querySelector('#tour-back');
        const next = card.querySelector('#tour-next');
        if (back) back.disabled = stepIndex === 0;
        if (next) next.textContent = stepIndex === steps.length - 1 ? 'Finish' : 'Next';
      }

      function go(delta) {
        const nextIndex = stepIndex + delta;
        if (nextIndex < 0) return;
        if (nextIndex >= steps.length) {
          stopTour();
          return;
        }
        stepIndex = nextIndex;
        showStep();
      }

      function startTour() {
        stepIndex = 0;
        simulateMode = true;
        showStep();
      }

      function stopTour() {
        clearHighlight();
        if (overlay) overlay.classList.remove('active');
        // Refresh live content after tour so the UI returns to real data.
        try { loadMetrics(); } catch (_) {}
        try { loadConfig(); } catch (_) {}
        try { loadEvents(); } catch (_) {}
        try { loadAudit(); } catch (_) {}
      }

      startBtn.addEventListener('click', startTour);
    })();

    loadMetrics();
    loadConfig();
    loadEvents();
    loadAudit();
    setInterval(loadMetrics, 5000);
    setInterval(loadEvents, 7000);
    setInterval(loadAudit, 9000);
  </script>
</body>
</html>
