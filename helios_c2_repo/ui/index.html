<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Helios C2 Demo</title>
  <style>
    :root {
      --bg: #0b1224;
      --panel: #111a30;
      --accent: #4cf0b5;
      --muted: #9ab0d6;
      --text: #e8ecf5;
      --warn: #f9c74f;
      --error: #f94144;
      --card: linear-gradient(135deg, rgba(76, 240, 181, 0.07), rgba(76, 150, 240, 0.04));
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'IBM Plex Sans', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(76, 240, 181, 0.08), transparent 35%),
                  radial-gradient(circle at 80% 10%, rgba(76, 150, 240, 0.08), transparent 30%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      position: sticky;
      top: 0;
      backdrop-filter: blur(8px);
      background: rgba(11,18,36,0.7);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      z-index: 10;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    nav a {
      color: var(--muted);
      margin-right: 16px;
      text-decoration: none;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    nav a.active, nav a:hover { color: var(--accent); }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: 12px;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 8px; letter-spacing: 0.01em; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px; }
    .kpi {
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(135deg, rgba(76, 240, 181, 0.14), rgba(76, 150, 240, 0.06));
      box-shadow: var(--shadow);
    }
    .kpi .label { color: var(--muted); font-size: 12px; letter-spacing: 0.03em; text-transform: uppercase; }
    .kpi .value { font-size: 24px; font-weight: 700; }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .card h3 { margin: 0 0 6px; }
    .muted { color: var(--muted); font-size: 14px; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 700; }
    .badge-live { background: rgba(76, 240, 181, 0.16); color: var(--accent); }
    .badge-mock { background: rgba(249, 65, 68, 0.12); color: var(--error); }
    pre {
      background: #0d152b;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius);
      padding: 12px;
      overflow: auto;
      color: var(--muted);
      white-space: pre-wrap;
      word-break: break-word;
    }
    button {
      background: linear-gradient(135deg, #4cf0b5, #4c96f0);
      color: #0a1020;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(76, 240, 181, 0.35);
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 12px 34px rgba(76, 240, 181, 0.45); }
    button:active { transform: translateY(0); }
    .status-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .small { font-size: 12px; }
    .panel { margin: 24px 0; padding: 16px; border-radius: var(--radius); background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); }
    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .chip {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
    }
    .chip.active { border-color: var(--accent); color: var(--accent); box-shadow: 0 8px 20px rgba(76,240,181,0.25); }
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      color: var(--muted);
    }
    .table th, .table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align: left;
      word-break: break-word;
      white-space: normal;
    }
    .table th { color: var(--text); font-size: 12px; letter-spacing: 0.03em; text-transform: uppercase; }
    input[type="number"], input[type="text"], textarea {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 8px;
      width: 100%;
    }
    textarea { min-height: 72px; resize: vertical; }
    .list { list-style: none; padding-left: 0; margin: 0; }
    .list li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.06); color: var(--muted); white-space: normal; word-break: break-word; }
    .scroll { max-height: 260px; overflow: auto; }
    .pill-button { padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.05); color: var(--text); cursor: pointer; }
    .pill-button:hover { border-color: var(--accent); color: var(--accent); }
    a.link { color: var(--accent); text-decoration: none; }
    .hero {
      padding: 18px 16px 12px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(76, 240, 181, 0.12), rgba(76, 150, 240, 0.10));
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow);
      margin-bottom: 18px;
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:10px;height:10px;border-radius:50%;background:var(--accent);"></div>
      <strong>Helios C2 Demo</strong>
      <span class="pill">In-process | Simulated infra</span>
    </div>
    <nav>
      <a href="#dashboard" id="nav-dashboard" class="active">Dashboard</a>
      <a href="#approvals" id="nav-approvals">Approvals</a>
      <a href="#guardrails" id="nav-guardrails">Guardrails</a>
      <a href="#modules" id="nav-modules">Modules</a>
      <a href="#intel" id="nav-intel">Intel</a>
      <a href="#infrastructure" id="nav-infrastructure">Infra Effector</a>
      <a href="#audit" id="nav-audit">Audit Trail</a>
      <a href="#data" id="nav-data">Data</a>
    </nav>
  </header>

  <main class="container">
    <div id="dashboard" class="page">
      <div class="hero">
        <h1>Mission Control</h1>
        <p class="muted">High-level counters and timings from live pipeline runs. Metrics are served via the lightweight API wrapper (/api/metrics).</p>
        <span class="badge badge-live">Implemented</span>
      </div>
      <div class="kpi-row" id="dashboard-kpis"></div>
      <div class="grid">
        <div class="card">
          <h3>Pipeline Counters</h3>
          <table class="table" id="metrics-counters"></table>
        </div>
        <div class="card">
          <h3>Stage Timings (s)</h3>
          <table class="table" id="metrics-timings"></table>
        </div>
      </div>
      <div class="panel">
        <div class="status-row"><strong>Source</strong><span class="muted small">pipeline.export.metrics.path</span></div>
        <div class="status-row"><strong>Refresh</strong><span class="muted small">Every 5s</span></div>
      </div>
    </div>

    <div id="approvals" class="page" style="display:none;">
      <div class="hero">
        <h1>Approvals & RBAC</h1>
        <p class="muted">Action-level defaults plus domain-required roles/min approvals. Data pulled from the served config (/api/config).</p>
        <span class="badge badge-live">Implemented</span>
      </div>
      <div id="approvals-content" class="grid"></div>
    </div>

    <div id="guardrails" class="page" style="display:none;">
      <div class="hero">
        <h1>Guardrails</h1>
        <p class="muted">Per-domain, per-event, per-asset, and pattern-based limits. Shows live config with drop counters from metrics.</p>
        <span class="badge badge-live">Implemented</span>
      </div>
      <div class="grid" id="guardrails-cards"></div>
    </div>

    <div id="modules" class="page" style="display:none;">
      <div class="hero">
        <h1>Media Modules</h1>
        <p class="muted">First-class ingest from media modules (vision/audio/thermal/gait/scene). Live config pulled from /api/config and last run stats from audit.</p>
        <span class="badge badge-live">Implemented</span>
      </div>
      <div class="panel">
        <div class="toolbar" id="module-nav"></div>
      </div>
      <div class="grid" id="modules-config"></div>
      <div class="card" id="module-details"></div>
      <div class="panel">
        <div class="status-row"><strong>Last ingest run</strong><span class="muted small" id="modules-run-meta">Waiting for audit...</span></div>
        <pre id="modules-run-stats">No ingest run recorded yet. Run pipeline with ingest.mode: modules_media.</pre>
      </div>
    </div>

    <div id="intel" class="page" style="display:none;">
      <div class="hero">
        <h1>Intel</h1>
        <p class="muted">Non-identifying entity profiles, an operator casebook, and conservative vision enhancement. These tools are demo-oriented and operate on local files on the server.</p>
        <span class="badge badge-live">Implemented</span>
      </div>

      <div class="panel">
        <div class="toolbar" id="intel-nav"></div>
      </div>

      <div id="intel-entity" class="grid"></div>
      <div id="intel-casebook" class="grid" style="display:none;"></div>
      <div id="intel-enhance" class="grid" style="display:none;"></div>
    </div>

    <div id="infrastructure" class="page" style="display:none;">
      <div class="hero">
        <h1>Infra Effector</h1>
        <p class="muted">Simulated infrastructure file export is implemented. HTTP forward here is mock-triggered for demo; no outbound calls. Data served via /api/events and /api/tasks.</p>
        <span class="badge badge-mock">Mock HTTP trigger</span>
      </div>
      <div class="grid">
        <div class="card">
          <h3>File Export</h3>
          <p class="muted">Writes infrastructure actions to JSONL at configured path.</p>
          <div class="status-row"><span>Status</span><span class="badge badge-live">Implemented</span></div>
          <pre id="infra-file-status">Loading...</pre>
        </div>
        <div class="card">
          <h3>HTTP Forward (Mock)</h3>
          <p class="muted">Sends the last actions payload to a mock endpoint and records success/failure locally.</p>
          <div class="status-row"><span>Status</span><span class="badge badge-mock">Mocked</span></div>
          <button id="mock-send">Send Mock Payload</button>
          <pre id="mock-result">No send yet.</pre>
        </div>
      </div>
    </div>

    <div id="data" class="page" style="display:none;">
      <div class="hero">
        <h1>Data</h1>
        <p class="muted">Live exports surfaced through the API wrapper: events, tasks, audit trail, and metrics. Media-module ingest runs show up here once the pipeline finishes.</p>
        <span class="badge badge-live">Implemented</span>
      </div>
      <div class="grid">
        <div class="card">
          <h3>Events & Tasks</h3>
          <p class="muted">Loaded from /api/events.</p>
          <div class="status-row"><span>Events</span><span class="muted small" id="events-count">0</span></div>
          <div class="status-row"><span>Tasks</span><span class="muted small" id="tasks-count">0</span></div>
          <ul class="list scroll" id="events-preview">Waiting for data...</ul>
        </div>
        <div class="card">
          <h3>Audit Trail</h3>
          <p class="muted">Tail of audit_log.jsonl via /api/audit.</p>
          <div class="status-row"><span>Status</span><span class="badge badge-live">Implemented</span></div>
          <ul class="list scroll" id="audit-preview">Waiting for data...</ul>
        </div>
        <div class="card">
          <h3>Suggested Course of Action</h3>
          <p class="muted">Aggregated from media modules and tasks; approve/deny with signature.</p>
          <div class="status-row"><span>Status</span><span class="badge badge-live" id="action-status">—</span></div>
          <ul class="list scroll" id="action-preview">Loading...</ul>
          <div class="status-row"><span class="small">Actor</span><input type="text" id="action-actor" placeholder="approver id" />
          </div>
          <div class="status-row"><span class="small">Token</span><input type="text" id="action-token" placeholder="signing secret" /></div>
          <div class="status-row"><span class="small">Rationale</span></div>
          <textarea id="action-rationale" placeholder="why approve/deny"></textarea>
          <div style="display:flex;gap:10px;margin-top:10px;">
            <button class="pill-button" id="action-approve">Approve</button>
            <button class="pill-button" id="action-deny">Deny</button>
          </div>
        </div>
      </div>
    </div>

    <div id="audit" class="page" style="display:none;">
      <div class="hero">
        <h1>Audit Trail</h1>
        <p class="muted">Signed hash-chain over pipeline actions and module ingest. Pulls from /api/audit with adjustable tail.</p>
        <span class="badge badge-live">Implemented</span>
      </div>
      <div class="panel">
        <div class="toolbar">
          <span class="muted small">Tail</span>
          <input type="number" id="audit-tail" value="120" min="20" max="2000" />
          <button class="pill-button" id="audit-refresh">Refresh</button>
          <button class="pill-button" id="audit-download">Download JSON</button>
        </div>
      </div>
      <div class="grid" id="audit-summaries"></div>
      <div class="card" style="overflow:auto;">
        <table class="table" id="audit-table"></table>
      </div>
    </div>
  </main>

  <script>
    const navLinks = document.querySelectorAll('nav a');
    const pages = document.querySelectorAll('.page');
    navLinks.forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        const target = link.getAttribute('href');
        pages.forEach(p => p.style.display = p.id === target.substring(1) ? 'block' : 'none');
        navLinks.forEach(n => n.classList.remove('active'));
        link.classList.add('active');
          if (target === '#guardrails') {
            renderGuardrails();
          }
          if (target === '#intel') {
            initIntelUI();
            loadIntelSelected();
          }
      });
    });
    const moduleCatalog = {
      vision: { title: 'Vision', desc: 'Detections, tracks, action recognition, ALPR, optional gait embeddings.', outputs: ['Detections', 'Tracks/ReID', 'ALPR', 'Actions'] },
      audio: { title: 'Audio', desc: 'Sound event detection and quick ASR transcript.', outputs: ['Sound events', 'Transcript'] },
      thermal: { title: 'Thermal', desc: 'Thermal anomaly scan and hotspot ratios.', outputs: ['Thermal frames', 'Hotspot ratios'] },
      gait: { title: 'Gait', desc: 'Gait embeddings piggybacked on vision detections.', outputs: ['Gait embeddings'] },
      scene: { title: 'Scene Fusion', desc: 'Scene graph fused from tracks, plates, and segments.', outputs: ['Scene graph'] },
    };

    let latestAudit = [];
    let modulesCfgCache = { modules: {}, media: {}, ingest: {} };
    let moduleStatsCache = null;
    let selectedModule = 'vision';
    let guardrailCfgCache = null;

    // -------------------- Intel UI --------------------
    const intelTabs = {
      entity: { title: 'Entity Profiles', desc: 'Derived from modules_media outputs when available (out/entity_profiles.json).' },
      casebook: { title: 'Casebook', desc: 'Local case/evidence/hypothesis tracker (out/casebook.json).' },
      enhance: { title: 'Vision Enhancement', desc: 'Conservative deterministic enhancement + optional face redaction.' },
    };
    let selectedIntelTab = 'entity';
    let intelInitialized = false;

    function initIntelUI() {
      if (intelInitialized) return;
      intelInitialized = true;
      const nav = document.getElementById('intel-nav');
      if (!nav) return;
      nav.innerHTML = '';
      Object.entries(intelTabs).forEach(([key, meta]) => {
        const btn = document.createElement('button');
        btn.className = `chip ${selectedIntelTab === key ? 'active' : ''}`;
        btn.dataset.tab = key;
        btn.textContent = meta.title;
        btn.addEventListener('click', () => {
          selectedIntelTab = key;
          updateIntelNavActive();
          showIntelTab(key);
          loadIntelSelected();
        });
        nav.appendChild(btn);
      });
      updateIntelNavActive();
      showIntelTab(selectedIntelTab);
      renderIntelEntitySkeleton();
      renderIntelCasebookSkeleton();
      renderIntelEnhanceSkeleton();
    }

    function updateIntelNavActive() {
      const nav = document.getElementById('intel-nav');
      if (!nav) return;
      nav.querySelectorAll('.chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.tab === selectedIntelTab);
      });
    }

    function showIntelTab(tab) {
      const entity = document.getElementById('intel-entity');
      const casebook = document.getElementById('intel-casebook');
      const enhance = document.getElementById('intel-enhance');
      if (!entity || !casebook || !enhance) return;
      entity.style.display = tab === 'entity' ? 'grid' : 'none';
      casebook.style.display = tab === 'casebook' ? 'grid' : 'none';
      enhance.style.display = tab === 'enhance' ? 'grid' : 'none';
    }

    function loadIntelSelected() {
      if (selectedIntelTab === 'entity') return loadEntityProfiles();
      if (selectedIntelTab === 'casebook') return loadCasebook();
      if (selectedIntelTab === 'enhance') return; // user-driven submit
    }

    function renderIntelEntitySkeleton() {
      const grid = document.getElementById('intel-entity');
      if (!grid) return;
      grid.innerHTML = '';
      const info = document.createElement('div');
      info.className = 'card';
      info.innerHTML = `<h3>${intelTabs.entity.title}</h3>
        <p class="muted">${intelTabs.entity.desc}</p>
        <div class="toolbar"><button class="pill-button" id="profiles-refresh">Refresh</button></div>
        <pre id="profiles-meta">Loading...</pre>`;
      const list = document.createElement('div');
      list.className = 'card';
      list.innerHTML = `<h3>Summaries</h3><table class="table" id="profiles-table"></table>`;
      const detail = document.createElement('div');
      detail.className = 'card';
      detail.innerHTML = `<h3>Entity Detail</h3>
        <div class="status-row"><span class="muted small">Entity ID</span><input id="profiles-entity-id" type="text" placeholder="ent-track or ent-uuid" /></div>
        <button class="pill-button" id="profiles-show">Show</button>
        <pre id="profiles-detail">Select an entity from the table or enter an entity id.</pre>`;
      grid.appendChild(info);
      grid.appendChild(list);
      grid.appendChild(detail);

      const refresh = document.getElementById('profiles-refresh');
      if (refresh) refresh.addEventListener('click', () => loadEntityProfiles(true));
      const show = document.getElementById('profiles-show');
      if (show) show.addEventListener('click', () => {
        const id = document.getElementById('profiles-entity-id')?.value;
        if (id) renderEntityProfileDetail(window.__heliosEntityProfiles || null, id);
      });
    }

    async function loadEntityProfiles(force = false) {
      try {
        const res = await fetch('/api/entity_profiles', { cache: force ? 'reload' : 'default' });
        if (!res.ok) throw new Error('entity profiles not found');
        const data = await res.json();
        window.__heliosEntityProfiles = data;
        renderEntityProfiles(data);
      } catch (e) {
        window.__heliosEntityProfiles = null;
        const meta = document.getElementById('profiles-meta');
        const table = document.getElementById('profiles-table');
        const detail = document.getElementById('profiles-detail');
        if (meta) meta.textContent = 'entity_profiles.json not found yet. Run ingest.mode: modules_media to generate.';
        if (table) table.innerHTML = '<tr><td class="muted" colspan="6">No entity profiles available.</td></tr>';
        if (detail) detail.textContent = 'No entity profile loaded.';
      }
    }

    function renderEntityProfiles(data) {
      const meta = document.getElementById('profiles-meta');
      const table = document.getElementById('profiles-table');
      if (!meta || !table) return;
      const summaries = data?.summaries || [];
      meta.textContent = JSON.stringify({
        schema_version: data?.schema_version,
        has_gait_tracks: data?.has_gait_tracks,
        entities: (data?.entities || []).length,
        summaries: summaries.length,
        generated_at: data?.generated_at,
      }, null, 2);

      if (!summaries.length) {
        table.innerHTML = '<tr><td class="muted" colspan="6">No summaries.</td></tr>';
        return;
      }
      table.innerHTML = '<tr><th>Entity</th><th>Track</th><th>Obs</th><th>Dominant Camera</th><th>Dominant Hour</th><th>Span (s)</th></tr>';
      summaries.slice(0, 50).forEach(s => {
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.innerHTML = `<td>${s.entity_id || '—'}</td><td>${s.track_id || '—'}</td><td>${s.num_observations ?? 0}</td><td>${s.dominant_camera ?? '—'}</td><td>${s.dominant_hour_of_day ?? '—'}</td><td>${(s.time_span_seconds ?? 0).toFixed ? (s.time_span_seconds ?? 0).toFixed(1) : (s.time_span_seconds ?? 0)}</td>`;
        row.addEventListener('click', () => {
          const input = document.getElementById('profiles-entity-id');
          if (input) input.value = s.entity_id;
          renderEntityProfileDetail(data, s.entity_id);
        });
        table.appendChild(row);
      });
    }

    function renderEntityProfileDetail(data, entityId) {
      const pre = document.getElementById('profiles-detail');
      if (!pre) return;
      const entities = data?.entities || [];
      const found = entities.find(e => e.entity_id === entityId);
      if (!found) {
        pre.textContent = `Entity not found: ${entityId}`;
        return;
      }
      // Keep detail concise.
      const obs = (found.observations || []).slice(0, 20);
      pre.textContent = JSON.stringify({
        entity_id: found.entity_id,
        track_id: found.track_id,
        observations_preview: obs,
        observations_total: (found.observations || []).length,
      }, null, 2);
    }

    function renderIntelCasebookSkeleton() {
      const grid = document.getElementById('intel-casebook');
      if (!grid) return;
      grid.innerHTML = '';
      const actions = document.createElement('div');
      actions.className = 'card';
      actions.innerHTML = `<h3>${intelTabs.casebook.title}</h3>
        <p class="muted">${intelTabs.casebook.desc}</p>
        <div class="toolbar"><button class="pill-button" id="casebook-refresh">Refresh</button></div>
        <pre id="casebook-meta">Loading...</pre>`;

      const createCase = document.createElement('div');
      createCase.className = 'card';
      createCase.innerHTML = `<h3>Create Case</h3>
        <div class="status-row"><span class="muted small">Title</span><input type="text" id="case-title" placeholder="e.g., Night perimeter anomaly" /></div>
        <div class="status-row"><span class="muted small">Domain</span><input type="text" id="case-domain" value="facility" /></div>
        <div class="status-row"><span class="muted small">Description</span></div>
        <textarea id="case-desc" placeholder="short description"></textarea>
        <button class="pill-button" id="case-create">Create</button>
        <pre id="case-create-result">—</pre>`;

      const addEvidence = document.createElement('div');
      addEvidence.className = 'card';
      addEvidence.innerHTML = `<h3>Add Evidence</h3>
        <div class="status-row"><span class="muted small">Kind</span><input type="text" id="ev-kind" value="CCTVClip" /></div>
        <div class="status-row"><span class="muted small">Source</span><input type="text" id="ev-source" value="operator" /></div>
        <div class="status-row"><span class="muted small">URI (optional)</span><input type="text" id="ev-uri" placeholder="file:// or http://" /></div>
        <div class="status-row"><span class="muted small">Case IDs (comma)</span><input type="text" id="ev-case-ids" placeholder="case-..." /></div>
        <div class="status-row"><span class="muted small">Tags (comma)</span><input type="text" id="ev-tags" placeholder="alpr, person" /></div>
        <div class="status-row"><span class="muted small">Description</span></div>
        <textarea id="ev-desc" placeholder="what this evidence is"></textarea>
        <button class="pill-button" id="ev-add">Add</button>
        <pre id="ev-add-result">—</pre>`;

      const createHyp = document.createElement('div');
      createHyp.className = 'card';
      createHyp.innerHTML = `<h3>Create Hypothesis</h3>
        <div class="status-row"><span class="muted small">Title</span><input type="text" id="hyp-title" placeholder="e.g., Tailgating attempt" /></div>
        <div class="status-row"><span class="muted small">Confidence</span><input type="number" id="hyp-conf" min="0" max="1" step="0.05" value="0.3" /></div>
        <div class="status-row"><span class="muted small">Case IDs (comma)</span><input type="text" id="hyp-case-ids" placeholder="case-..." /></div>
        <div class="status-row"><span class="muted small">Evidence IDs (comma)</span><input type="text" id="hyp-ev-ids" placeholder="ev-..." /></div>
        <div class="status-row"><span class="muted small">Description</span></div>
        <textarea id="hyp-desc" placeholder="hypothesis statement"></textarea>
        <div class="status-row"><span class="muted small">Rationale</span></div>
        <textarea id="hyp-rationale" placeholder="why you believe this"></textarea>
        <button class="pill-button" id="hyp-create">Create</button>
        <pre id="hyp-create-result">—</pre>`;

      const view = document.createElement('div');
      view.className = 'card';
      view.innerHTML = `<h3>Casebook Snapshot</h3>
        <pre id="casebook-json">Waiting...</pre>`;

      grid.appendChild(actions);
      grid.appendChild(createCase);
      grid.appendChild(addEvidence);
      grid.appendChild(createHyp);
      grid.appendChild(view);

      document.getElementById('casebook-refresh')?.addEventListener('click', () => loadCasebook(true));
      document.getElementById('case-create')?.addEventListener('click', async () => {
        const title = document.getElementById('case-title')?.value || 'Untitled';
        const domain = document.getElementById('case-domain')?.value || 'facility';
        const description = document.getElementById('case-desc')?.value || '';
        await casebookPost({ op: 'create_case', title, domain, description }, 'case-create-result');
        loadCasebook(true);
      });
      document.getElementById('ev-add')?.addEventListener('click', async () => {
        const kind = document.getElementById('ev-kind')?.value || 'Evidence';
        const source = document.getElementById('ev-source')?.value || 'operator';
        const uri = document.getElementById('ev-uri')?.value || null;
        const description = document.getElementById('ev-desc')?.value || '';
        const caseIds = (document.getElementById('ev-case-ids')?.value || '').split(',').map(s => s.trim()).filter(Boolean);
        const tags = (document.getElementById('ev-tags')?.value || '').split(',').map(s => s.trim()).filter(Boolean);
        await casebookPost({ op: 'add_evidence', kind, source, uri, description, case_ids: caseIds, tags }, 'ev-add-result');
        loadCasebook(true);
      });
      document.getElementById('hyp-create')?.addEventListener('click', async () => {
        const title = document.getElementById('hyp-title')?.value || 'Hypothesis';
        const confidence = Number(document.getElementById('hyp-conf')?.value || 0.0);
        const description = document.getElementById('hyp-desc')?.value || '';
        const rationale = document.getElementById('hyp-rationale')?.value || '';
        const caseIds = (document.getElementById('hyp-case-ids')?.value || '').split(',').map(s => s.trim()).filter(Boolean);
        const evidenceIds = (document.getElementById('hyp-ev-ids')?.value || '').split(',').map(s => s.trim()).filter(Boolean);
        await casebookPost({ op: 'create_hypothesis', title, description, rationale, confidence, case_ids: caseIds, evidence_ids: evidenceIds }, 'hyp-create-result');
        loadCasebook(true);
      });
    }

    async function casebookPost(payload, resultElId) {
      const out = document.getElementById(resultElId);
      if (out) out.textContent = 'Sending...';
      try {
        const res = await fetch('/api/casebook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'request failed');
        if (out) out.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        if (out) out.textContent = `Failed: ${e.message || e}`;
      }
    }

    async function loadCasebook(force = false) {
      try {
        const res = await fetch('/api/casebook', { cache: force ? 'reload' : 'default' });
        if (!res.ok) throw new Error('casebook unavailable');
        const data = await res.json();
        const meta = document.getElementById('casebook-meta');
        const pre = document.getElementById('casebook-json');
        if (meta) meta.textContent = JSON.stringify({
          schema_version: data?.schema_version,
          cases: (data?.cases || []).length,
          evidence: (data?.evidence || []).length,
          hypotheses: (data?.hypotheses || []).length,
        }, null, 2);
        if (pre) pre.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        const meta = document.getElementById('casebook-meta');
        const pre = document.getElementById('casebook-json');
        if (meta) meta.textContent = 'Casebook not found yet. It will be created automatically after your first create/add action.';
        if (pre) pre.textContent = '—';
      }
    }

    function renderIntelEnhanceSkeleton() {
      const grid = document.getElementById('intel-enhance');
      if (!grid) return;
      grid.innerHTML = '';
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h3>${intelTabs.enhance.title}</h3>
        <p class="muted">${intelTabs.enhance.desc} Provide a server-local path to a video file (e.g., under the workspace).</p>
        <div class="status-row"><span class="muted small">Video path</span><input id="enh-video" type="text" placeholder="/workspaces/.../some.mp4" /></div>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
          <div class="card" style="box-shadow:none;border:1px solid rgba(255,255,255,0.06);">
            <div class="status-row"><span class="muted small">Deinterlace</span><input id="enh-deint" type="text" value="false" /></div>
            <div class="status-row"><span class="muted small">Stabilize</span><input id="enh-stab" type="text" value="true" /></div>
            <div class="status-row"><span class="muted small">Redact faces</span><input id="enh-redact" type="text" value="false" /></div>
          </div>
          <div class="card" style="box-shadow:none;border:1px solid rgba(255,255,255,0.06);">
            <div class="status-row"><span class="muted small">Denoise window</span><input id="enh-denoise" type="number" value="2" min="0" max="8" /></div>
            <div class="status-row"><span class="muted small">Sharpen amount</span><input id="enh-sharp" type="number" value="0.8" step="0.1" min="0" max="2" /></div>
            <div class="status-row"><span class="muted small">SR scale</span><input id="enh-scale" type="number" value="2" min="1" max="4" /></div>
          </div>
          <div class="card" style="box-shadow:none;border:1px solid rgba(255,255,255,0.06);">
            <div class="status-row"><span class="muted small">Max frames</span><input id="enh-max" type="number" value="120" min="1" max="5000" /></div>
            <div class="muted small">Tip: keep max frames small for quick runs.</div>
          </div>
        </div>
        <button class="pill-button" id="enh-run">Run Enhancement</button>
        <pre id="enh-result">—</pre>
        <div id="enh-artifacts"></div>`;
      grid.appendChild(card);

      document.getElementById('enh-run')?.addEventListener('click', async () => {
        const video_path = document.getElementById('enh-video')?.value?.trim();
        if (!video_path) return alert('Provide a server-local video path.');
        const cfg = {
          deinterlace: (document.getElementById('enh-deint')?.value || 'false') === 'true',
          stabilize: (document.getElementById('enh-stab')?.value || 'true') === 'true',
          redact_faces: (document.getElementById('enh-redact')?.value || 'false') === 'true',
          denoise_window: Number(document.getElementById('enh-denoise')?.value || 2),
          sharpen_amount: Number(document.getElementById('enh-sharp')?.value || 0.8),
          sr_scale: Number(document.getElementById('enh-scale')?.value || 2),
          max_frames: Number(document.getElementById('enh-max')?.value || 120),
        };
        await runEnhancement(video_path, cfg);
      });
    }

    async function runEnhancement(video_path, config) {
      const pre = document.getElementById('enh-result');
      const artifacts = document.getElementById('enh-artifacts');
      if (pre) pre.textContent = 'Running...';
      if (artifacts) artifacts.innerHTML = '';
      try {
        const res = await fetch('/api/enhance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ video_path, config }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.detail || data?.error || 'enhancement failed');
        if (pre) pre.textContent = JSON.stringify(data.result, null, 2);

        const urls = data?.result?.artifact_urls || {};
        const paths = data?.result?.artifact_paths || {};
        if (artifacts) {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `<h3>Artifacts</h3>
            <div class="status-row"><span>Video</span><span class="muted small">${paths.video || '—'}</span></div>
            <div class="status-row"><span>Montage</span><span class="muted small">${paths.montage || '—'}</span></div>
            <div class="status-row"><span>Metadata</span><span class="muted small">${paths.metadata || '—'}</span></div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              ${urls.video ? `<a class="link" href="${urls.video}" target="_blank">Open video</a>` : ''}
              ${urls.montage ? `<a class="link" href="${urls.montage}" target="_blank">Open montage</a>` : ''}
              ${urls.metadata ? `<a class="link" href="${urls.metadata}" target="_blank">Open metadata</a>` : ''}
            </div>
            ${urls.montage ? `<div style="margin-top:10px;"><img src="${urls.montage}" style="max-width:100%;border-radius:12px;border:1px solid rgba(255,255,255,0.08);" /></div>` : ''}
            ${urls.video ? `<div style="margin-top:10px;"><video controls style="width:100%;border-radius:12px;border:1px solid rgba(255,255,255,0.08);" src="${urls.video}"></video></div>` : ''}`;
          artifacts.appendChild(card);
        }
      } catch (e) {
        if (pre) pre.textContent = `Failed: ${e.message || e}`;
      }
    }

    async function loadMetrics() {
      const kpi = document.getElementById('dashboard-kpis');
      const countersTable = document.getElementById('metrics-counters');
      const timingsTable = document.getElementById('metrics-timings');
      try {
        const res = await fetch('/api/metrics');
        if (!res.ok) throw new Error('metrics not found');
        const text = await res.text();
        const lines = text.trim().split('\n').filter(Boolean);
        const metrics = lines.map(line => {
          const [name, val] = line.trim().split(/\s+/);
          const num = Number(val);
          return { name, val: isNaN(num) ? val : num };
        });

        const lookup = Object.fromEntries(metrics.map(m => [m.name, m.val]));
        const kpiKeys = ['helios_events_raw', 'helios_decision_count', 'helios_export_json_writes', 'helios_guardrails_count'];
        if (kpi) {
          kpi.innerHTML = '';
          kpiKeys.forEach(key => {
            const label = key.replace('helios_', '').replace(/_/g, ' ');
            const val = lookup[key] ?? '—';
            const card = document.createElement('div');
            card.className = 'kpi';
            card.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
            kpi.appendChild(card);
          });
        }

        const counterKeys = [
          'helios_ingest_count',
          'helios_fusion_count',
          'helios_rules_count',
          'helios_events_raw',
          'helios_decision_count',
          'helios_guardrails_count',
          'helios_risk_budget_count',
          'helios_autonomy_count',
          'helios_export_json_writes',
        ];
        const timingKeys = [
          'helios_ingest_seconds',
          'helios_fusion_seconds',
          'helios_rules_seconds',
          'helios_decision_seconds',
          'helios_guardrails_seconds',
          'helios_risk_budget_seconds',
          'helios_autonomy_seconds',
        ];

        const renderTable = (table, keys, emptyMsg) => {
          if (!table) return;
          if (!keys.length) {
            table.innerHTML = `<tr><td class="muted" colspan="2">${emptyMsg}</td></tr>`;
            return;
          }
          table.innerHTML = '<tr><th>Metric</th><th>Value</th></tr>';
          keys.forEach(key => {
            const row = document.createElement('tr');
            const label = key.replace('helios_', '').replace(/_/g, ' ');
            const val = lookup[key];
            row.innerHTML = `<td>${label}</td><td>${val ?? '—'}</td>`;
            table.appendChild(row);
          });
        };

        renderTable(countersTable, counterKeys, 'No counters');
        renderTable(timingsTable, timingKeys, 'No timings');
      } catch (e) {
        if (kpi) kpi.innerHTML = '';
        if (countersTable) countersTable.innerHTML = '<tr><td class="muted" colspan="2">metrics.prom not found</td></tr>';
        if (timingsTable) timingsTable.innerHTML = '<tr><td class="muted" colspan="2">metrics.prom not found</td></tr>';
      }
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        const text = await res.text();
        const cfg = jsyaml.load(text);
        guardrailCfgCache = cfg;
        renderApprovals(cfg);
        renderGuardrails(cfg);
        renderInfra(cfg);
        renderModules(cfg);
      } catch (e) {
        console.error('Config load failed', e);
      }
    }

    async function loadEvents() {
      try {
        const res = await fetch('/api/events');
        if (!res.ok) throw new Error('events not found');
        const data = await res.json();
        const events = data.events || [];
        const tasks = data.tasks || [];
        document.getElementById('events-count').textContent = events.length;
        document.getElementById('tasks-count').textContent = tasks.length;
        renderEventsTasks(events, tasks);
      } catch (e) {
        document.getElementById('events-preview').innerHTML = '<li>No events.json yet. Run the pipeline or modules_media ingest.</li>';
      }
    }

    async function loadAudit(tailOverride) {
      const tail = tailOverride || Number(document.getElementById('audit-tail')?.value || 120);
      try {
        const res = await fetch(`/api/audit?tail=${tail}`);
        if (!res.ok) throw new Error('audit not found');
        const data = await res.json();
        latestAudit = data.audit || [];
        renderAuditPreview(latestAudit.slice(-10));
        renderModulesStats();
        renderAuditSummaries();
        renderAuditTable();
        renderGuardrails();
        loadActionSuggestion();
      } catch (e) {
        latestAudit = [];
        moduleStatsCache = null;
        document.getElementById('audit-preview').innerHTML = '<li>No audit_log.jsonl yet.</li>';
        document.getElementById('modules-run-meta').textContent = 'Waiting for audit...';
        document.getElementById('modules-run-stats').textContent = 'No ingest run recorded yet. Run pipeline with ingest.mode: modules_media.';
        renderAuditSummaries(true);
        renderAuditTable(true);
        renderModuleDetails();
        renderGuardrails();
      }
    }

    async function loadActionSuggestion() {
      try {
        const res = await fetch('/api/action_suggestion');
        if (!res.ok) throw new Error('suggestion not found');
        const data = await res.json();
        renderActionSuggestion(data);
      } catch (e) {
        renderActionSuggestion(null, true);
      }
    }

    function renderApprovals(cfg) {
      const actionDefaults = cfg?.pipeline?.infrastructure?.action_defaults || {};
      const rbacActions = cfg?.pipeline?.rbac?.action_requirements || {};
      const container = document.getElementById('approvals-content');
      container.innerHTML = '';
      Object.entries({ ...actionDefaults, ...rbacActions }).forEach(([action, vals]) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h3>${action}</h3>
          <div class="status-row"><span>Required Roles</span><span class="muted small">${(vals.required_roles || []).join(', ') || 'none'}</span></div>
          <div class="status-row"><span>Min Approvals</span><span class="muted small">${vals.min_approvals ?? 0}</span></div>
          <div class="status-row"><span>Status</span><span class="badge badge-live">Implemented</span></div>`;
        container.appendChild(card);
      });
      if (!container.childElementCount) {
        container.innerHTML = '<div class="card"><h3>No action defaults</h3><div class="muted">Add under pipeline.infrastructure.action_defaults.</div></div>';
      }
    }

    function renderGuardrails(cfg) {
      const source = cfg || guardrailCfgCache;
      const rate = source?.pipeline?.guardrails?.rate_limits || {};
      const riskBudgets = source?.pipeline?.guardrails?.risk_budgets || {};
      const healthThreshold = source?.pipeline?.guardrails?.health_alert_drop_ratio;
      const grid = document.getElementById('guardrails-cards');
      if (!grid) return;
      grid.innerHTML = '';

      const cards = [
        {
          title: 'Rate Limits',
          body: [
            ['Per Domain', rate.per_domain],
            ['Per Event', rate.per_event],
            ['Total', rate.total],
            ['Per Asset', rate.per_asset_infra],
            ['Per Asset Pattern', rate.per_asset_infra_patterns],
          ],
        },
        {
          title: 'Risk Budgets',
          body: Object.keys(riskBudgets).length
            ? Object.entries(riskBudgets).map(([tenant, vals]) => [tenant, vals])
            : [['None configured', '']],
        },
        {
          title: 'Health Alerts',
          body: [['Drop ratio alert threshold', healthThreshold ?? 'unset']],
        },
      ];

      cards.forEach(({ title, body }) => {
        const card = document.createElement('div');
        card.className = 'card';
        const rows = body.map(([label, val]) => {
          const display = typeof val === 'object' ? JSON.stringify(val, null, 2) : (val ?? 'unset');
          return `<div class="status-row"><span>${label}</span><span class="muted small">${display}</span></div>`;
        }).join('');
        card.innerHTML = `<h3>${title}</h3>${rows}<div class="status-row"><span>Status</span><span class="badge badge-live">Implemented</span></div>`;
        grid.appendChild(card);
      });
    }

    function renderInfra(cfg) {
      const infra = cfg?.pipeline?.export?.infrastructure || {};
      const path = infra.path || 'out/infrastructure_actions.jsonl';
      document.getElementById('infra-file-status').textContent = `Path: ${path}\nRotate: ${infra.rotate_max_bytes || 'none'}\nHTTP: ${infra.http ? 'configured' : 'not configured'}`;
    }

    function renderModules(cfg) {
      const ingest = cfg?.pipeline?.ingest || {};
      const modules = ingest.modules || {};
      const media = ingest.media || {};
      modulesCfgCache = { modules, media, ingest };
      const grid = document.getElementById('modules-config');
      grid.innerHTML = '';

      const nav = document.getElementById('module-nav');
      if (nav) {
        nav.innerHTML = '';
        Object.entries(moduleCatalog).forEach(([key, meta]) => {
          const enabled = Boolean(modules[`enable_${key}`] ?? (key === 'gait' ? modules.enable_gait : false));
          const btn = document.createElement('button');
          btn.className = `chip ${selectedModule === key ? 'active' : ''}`;
          btn.dataset.module = key;
          btn.textContent = meta.title;
          if (!enabled) btn.style.opacity = 0.55;
          btn.addEventListener('click', () => {
            selectedModule = key;
            updateModuleNavActive();
            renderModuleDetails();
          });
          nav.appendChild(btn);
        });
        updateModuleNavActive();
      }

      const modeCard = document.createElement('div');
      modeCard.className = 'card';
      modeCard.innerHTML = `<h3>Ingest Mode</h3>
        <div class="status-row"><span>Mode</span><span class="badge ${ingest.mode === 'modules_media' ? 'badge-live' : 'badge-mock'}">${ingest.mode || 'unset'}</span></div>
        <div class="status-row"><span>Media Path</span><span class="muted small">${media.path || 'examples/scenario_minimal.yaml'}</span></div>
        <div class="status-row"><span>Stride</span><span class="muted small">${media.stride ?? 8}</span></div>`;
      grid.appendChild(modeCard);

      const toggles = ['enable_vision', 'enable_audio', 'enable_thermal', 'enable_gait', 'enable_scene'];
      const togglesCard = document.createElement('div');
      togglesCard.className = 'card';
      togglesCard.innerHTML = `<h3>Modules Enabled</h3>${toggles.map(name => {
        const on = Boolean(modules[name]);
        return `<div class="status-row"><span>${name.replace('enable_', '').toUpperCase()}</span><span class="badge ${on ? 'badge-live' : 'badge-mock'}">${on ? 'on' : 'off'}</span></div>`;
      }).join('')}`;
      grid.appendChild(togglesCard);

      const tuningCard = document.createElement('div');
      tuningCard.className = 'card';
      tuningCard.innerHTML = `<h3>Sampling</h3>
        <div class="status-row"><span>Downscale</span><span class="muted small">${modules.downscale ?? 1}</span></div>
        <div class="status-row"><span>Notes</span><span class="muted small">Stride/downscale impact frame and audio hop selection.</span></div>`;
      grid.appendChild(tuningCard);

      renderModuleDetails();
      renderModulesStats();
    }

    function updateModuleNavActive() {
      const nav = document.getElementById('module-nav');
      if (!nav) return;
      nav.querySelectorAll('.chip').forEach(chip => {
        const key = chip.dataset.module;
        chip.classList.toggle('active', key === selectedModule);
      });
    }

    function renderModuleDetails() {
      const container = document.getElementById('module-details');
      if (!container) return;
      const modules = modulesCfgCache.modules || {};
      const media = modulesCfgCache.media || {};
      const key = moduleCatalog[selectedModule] ? selectedModule : Object.keys(moduleCatalog)[0];
      const meta = moduleCatalog[key];
      const enabled = Boolean(modules[`enable_${key}`] ?? (key === 'gait' ? modules.enable_gait : false));
      const stats = (moduleStatsCache && moduleStatsCache.stats) || {};
      const count = stats[key] ?? 0;
      const ingestPath = (moduleStatsCache && moduleStatsCache.path) || media.path || 'n/a';
      const stride = (moduleStatsCache && moduleStatsCache.stride) ?? media.stride ?? 8;
      const outputs = (meta.outputs || []).join(' · ');

      container.innerHTML = `<h3>${meta.title}</h3>
        <p class="muted">${meta.desc}</p>
        <div class="status-row"><span>Status</span><span class="badge ${enabled ? 'badge-live' : 'badge-mock'}">${enabled ? 'enabled' : 'disabled'}</span></div>
        <div class="status-row"><span>Last outputs</span><span class="muted small">${count ? `${count} fragments` : 'n/a'}</span></div>
        <div class="status-row"><span>Media path</span><span class="muted small">${ingestPath}</span></div>
        <div class="status-row"><span>Stride</span><span class="muted small">${stride}</span></div>
        <div class="status-row"><span>Outputs</span><span class="muted small">${outputs || '—'}</span></div>`;
    }

    function renderActionSuggestion(data, empty = false) {
      const statusEl = document.getElementById('action-status');
      const pre = document.getElementById('action-preview');
      if (!statusEl || !pre) return;
      if (empty || !data) {
        statusEl.textContent = 'missing';
        statusEl.className = 'badge badge-mock';
        pre.innerHTML = '<li>No action suggestion available yet. Run modules_media or pipeline to generate.</li>';
        return;
      }
      statusEl.textContent = data.status || 'proposed';
      statusEl.className = `badge ${data.status === 'approved' ? 'badge-live' : data.status === 'denied' ? 'badge-mock' : 'badge-live'}`;
      const lines = [];
      lines.push(`Proposed at ${new Date((data.proposed_at || Date.now()) * 1000).toLocaleString()}`);
      if (data.plain_text) lines.push(`Plan: ${data.plain_text}`);
      if (data.recommended) {
        lines.push(`Action: ${data.recommended.action || 'action'} on ${data.recommended.asset_id || 'asset'} (${data.recommended.infrastructure_type || 'infra'}) domain ${data.recommended.assignee_domain || 'n/a'}`);
      }
      if (data.summary) {
        lines.push(`Context: ${data.summary.events_seen || 0} events, ${data.summary.tasks_approved || 0} approved tasks`);
      }
      if (data.decided_by) {
        lines.push(`Decision by ${data.decided_by}: ${data.status} (${data.decision_rationale || 'no rationale'})`);
      }
      pre.innerHTML = lines.map(t => `<li>${t}</li>`).join('');
    }

    function renderEventsTasks(events, tasks) {
      const list = document.getElementById('events-preview');
      if (!list) return;
      list.innerHTML = '';
      const topEvents = events.slice(0, 5);
      const topTasks = tasks.slice(0, 5);
      if (!topEvents.length && !topTasks.length) {
        list.innerHTML = '<li>No events or tasks yet.</li>';
        return;
      }
      topEvents.forEach(ev => {
        const li = document.createElement('li');
        const when = ev.ts_ms ? new Date(ev.ts_ms).toLocaleString() : 'recent';
        li.textContent = `[Event] ${ev.category || ev.id || 'unknown'} in ${ev.domain || 'domain'} (sev ${ev.severity_label || ev.severity || '?'}) at ${when}`;
        list.appendChild(li);
      });
      topTasks.forEach(t => {
        const li = document.createElement('li');
        li.textContent = `[Task] ${t.action || 'action'} -> ${t.asset_id || 'asset'} (${t.infrastructure_type || 'infra'}) domain ${t.assignee_domain || 'n/a'} status ${t.status || 'pending'}`;
        list.appendChild(li);
      });
    }

    function renderAuditPreview(entries) {
      const list = document.getElementById('audit-preview');
      if (!list) return;
      list.innerHTML = '';
      if (!entries || !entries.length) {
        list.innerHTML = '<li>No audit entries.</li>';
        return;
      }
      entries.forEach(evt => {
        const li = document.createElement('li');
        const ts = evt.ts_unix ? new Date(evt.ts_unix * 1000).toLocaleString() : '';
        li.textContent = `${ts}: ${evt.kind} — ${summarizeAuditPayload(evt)}`;
        list.appendChild(li);
      });
    }

    function summarizeAuditPayload(evt) {
      const kind = evt.kind;
      const p = evt.payload || {};
      switch (kind) {
        case 'ingest_modules_done':
          return `modules_media path ${p.path} stride ${p.stride} stats ${JSON.stringify(p.stats)}`;
        case 'rules_done':
          return `events ${p.events}, after governance ${p.events_after_governance}, blocked ${p.blocked}`;
        case 'guardrails':
          return `kept ${p.kept || 0} (drops ${JSON.stringify(p)})`;
        case 'action_suggestion':
          return `suggested ${p.recommended?.action || 'action'} for ${p.recommended?.asset_id || 'asset'} status ${p.status}`;
        case 'action_suggestion_decision':
          return `decision ${p.decision} for ${p.suggestion_id}`;
        default:
          return JSON.stringify(p);
      }
    }

    function renderModulesStats() {
      if (!Array.isArray(latestAudit) || !latestAudit.length) return;
      const ingestEvent = [...latestAudit].reverse().find(evt => evt.kind === 'ingest_modules_done');
      if (!ingestEvent) return;
      const payload = ingestEvent.payload || {};
      const stats = payload.stats || {};
      const summary = {
        path: payload.path,
        stride: payload.stride,
        modules_seen: Object.keys(stats).length,
      };
      moduleStatsCache = { stats, path: payload.path, stride: payload.stride, ts: ingestEvent.ts_unix, seq: ingestEvent.seq };
      document.getElementById('modules-run-meta').textContent = `seq ${ingestEvent.seq} · ${new Date(ingestEvent.ts_unix * 1000).toLocaleString()}`;
      document.getElementById('modules-run-stats').textContent = JSON.stringify({ summary, modules: stats }, null, 2);
      renderModuleDetails();
    }

    function renderAuditSummaries(empty = false) {
      const grid = document.getElementById('audit-summaries');
      if (!grid) return;
      grid.innerHTML = '';
      if (empty || !latestAudit.length) {
        grid.innerHTML = '<div class="card"><h3>No audit yet</h3><div class="muted">Run the pipeline to generate audit_log.jsonl.</div></div>';
        return;
      }
      const last = latestAudit[latestAudit.length - 1];
      const kinds = latestAudit.reduce((acc, evt) => {
        acc[evt.kind] = (acc[evt.kind] || 0) + 1;
        return acc;
      }, {});
      const kindList = Object.entries(kinds).sort((a, b) => b[1] - a[1]).slice(0, 4);
      const summaryCard = document.createElement('div');
      summaryCard.className = 'card';
      summaryCard.innerHTML = `<h3>Overview</h3>
        <div class="status-row"><span>Total entries</span><span class="muted small">${latestAudit.length}</span></div>
        <div class="status-row"><span>Last kind</span><span class="muted small">${last.kind}</span></div>
        <div class="status-row"><span>Latest seq</span><span class="muted small">${last.seq}</span></div>
        <div class="status-row"><span>Last time</span><span class="muted small">${new Date(last.ts_unix * 1000).toLocaleString()}</span></div>`;
      grid.appendChild(summaryCard);

      const kindsCard = document.createElement('div');
      kindsCard.className = 'card';
      kindsCard.innerHTML = `<h3>Top kinds</h3>${kindList.map(([k, v]) => `<div class="status-row"><span>${k}</span><span class="muted small">${v}</span></div>`).join('')}`;
      grid.appendChild(kindsCard);
    }

    function renderAuditTable(empty = false) {
      const table = document.getElementById('audit-table');
      if (!table) return;
      if (empty || !latestAudit.length) {
        table.innerHTML = '<tr><td class="muted" colspan="5">No audit entries yet.</td></tr>';
        return;
      }
      table.innerHTML = '<tr><th>Seq</th><th>Kind</th><th>Actor</th><th>Time</th><th>Description</th></tr>';
      latestAudit.slice().reverse().forEach(evt => {
        const row = document.createElement('tr');
        const desc = summarizeAuditPayload(evt);
        row.innerHTML = `<td>${evt.seq}</td><td>${evt.kind}</td><td>${evt.actor || 'n/a'}</td><td>${new Date(evt.ts_unix * 1000).toLocaleString()}</td><td>${desc}</td>`;
        table.appendChild(row);
      });
    }

    document.getElementById('mock-send').addEventListener('click', () => {
      const payload = [{ id: 'mock1', action: 'lock', asset_id: 'demo_gate', infrastructure_type: 'gate' }];
      document.getElementById('mock-result').textContent = 'Sending...';
      setTimeout(() => {
        document.getElementById('mock-result').textContent = 'Mock send recorded locally (no network).';
      }, 400);
    });

    const auditRefreshBtn = document.getElementById('audit-refresh');
    if (auditRefreshBtn) {
      auditRefreshBtn.addEventListener('click', () => loadAudit());
    }
    const auditDownloadBtn = document.getElementById('audit-download');
    if (auditDownloadBtn) {
      auditDownloadBtn.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(latestAudit, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'audit_log_tail.json';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    const approveBtn = document.getElementById('action-approve');
    const denyBtn = document.getElementById('action-deny');
    const decide = async (decision) => {
      const actor = document.getElementById('action-actor')?.value || 'human';
      const token = document.getElementById('action-token')?.value || '';
      const rationale = document.getElementById('action-rationale')?.value || '';
      try {
        const res = await fetch('/api/action_suggestion', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ decision, actor, token, rationale }),
        });
        if (!res.ok) throw new Error('decision failed');
        const data = await res.json();
        renderActionSuggestion(data.suggestion);
        loadAudit();
      } catch (e) {
        alert('Failed to record decision.');
      }
    };
    if (approveBtn) approveBtn.addEventListener('click', () => decide('approve'));
    if (denyBtn) denyBtn.addEventListener('click', () => decide('deny'));

    loadMetrics();
    loadConfig();
    loadEvents();
    loadAudit();
    setInterval(loadMetrics, 5000);
    setInterval(loadEvents, 7000);
    setInterval(loadAudit, 9000);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</body>
</html>
